import{_ as n,c as a,o as p,ag as l}from"./chunks/framework.BPQUDke-.js";const o="/blog/micro-web/single-spa-status.png",D=JSON.parse('{"title":"使用方案及子应用的加载原理","description":"","frontmatter":{"outline":[2,3,4]},"headers":[],"relativePath":"micro-web/single-spa.md","filePath":"micro-web/single-spa.md","lastUpdated":1740476554000}'),e={name:"micro-web/single-spa.md"};function r(c,s,t,E,i,y){return p(),a("div",null,s[0]||(s[0]=[l(`<h1 id="使用方案及子应用的加载原理" tabindex="-1">使用方案及子应用的加载原理 <a class="header-anchor" href="#使用方案及子应用的加载原理" aria-label="Permalink to &quot;使用方案及子应用的加载原理&quot;">​</a></h1><h2 id="single-spa-使用方案" tabindex="-1">single-spa 使用方案 <a class="header-anchor" href="#single-spa-使用方案" aria-label="Permalink to &quot;single-spa 使用方案&quot;">​</a></h2><p><a href="https://zh-hans.single-spa.js.org/docs/getting-started-overview" target="_blank" rel="noreferrer">single-spa</a> 提供有 <code>cli</code> 工具，通过 <code>cli</code> 工具可以快速创建一个 <code>single-spa</code> 应用。</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki slack-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#DCDCAA;">npm</span><span style="color:#CE9178;"> install</span><span style="color:#CE9178;"> create-single-spa</span><span style="color:#CE9178;"> -g</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><ul><li>第一步 <code>Directory for new project</code> 项目的名称，默认直接在当前目录创建；建议使用统一的命名方式比如 <code>xxx-manager-f2e</code></li><li>第二步 <code>single-spa application / parcel</code> 子应用的创建类型；<code>single-spa root config</code> 基座的创建类型</li><li>第三步 无论是基座还是子应用最终都会出现 <code>Organization name</code> 个人建议使用组织、业务、公司名等统一的命名方式</li></ul><p>最终生成项目的 <code>package.json</code> 中 <code>name</code> 是 <code>Organization name/Directory for new project</code> 的组合。<strong>基座除外，基座名为 <code>Organization name/root-config</code></strong></p><h3 id="基座" tabindex="-1">基座 <a class="header-anchor" href="#基座" aria-label="Permalink to &quot;基座&quot;">​</a></h3><p>一般用来加载子应用（通过 <a href="/blog/_project/module_standard.html">SystemJS</a>）、数据通信、承接项目中的 <code>layout</code> 功能。脚手架创建出来的项目关注两个文件，分别为 <code>src/index.ejs</code>、<code>src/micro-web-root-config.js</code>。<em><code>micro-web</code> 是组织名</em></p><div class="language-html line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki slack-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A9955;">&lt;!-- src/index.ejs --&gt;</span></span>
<span class="line"><span style="color:#808080;">&lt;</span><span style="color:#569CD6;">script</span><span style="color:#9CDCFE;"> type</span><span style="color:#D4D4D4;">=</span><span style="color:#CE9178;">&quot;injector-importmap&quot;</span><span style="color:#808080;">&gt;</span></span>
<span class="line"><span style="color:#D4D4D4;">  {</span></span>
<span class="line"><span style="color:#D4D4D4;">    &quot;imports&quot;: {</span></span>
<span class="line"><span style="color:#D4D4D4;">      &quot;@micro-web/root-config&quot;: &quot;//localhost:9000/micro-web-root-config.js&quot;,</span></span>
<span class="line"><span style="color:#D4D4D4;">      &quot;@single-spa/welcome&quot;: &quot;https://cdn.jsdelivr.net/npm/single-spa-welcome/dist/single-spa-welcome.min.js&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#808080;">&lt;/</span><span style="color:#569CD6;">script</span><span style="color:#808080;">&gt;</span></span>
<span class="line"><span style="color:#808080;">&lt;</span><span style="color:#569CD6;">script</span><span style="color:#808080;">&gt;</span></span>
<span class="line"><span style="color:#9CDCFE;">  window</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">importMapInjector</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">initPromise</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">then</span><span style="color:#D4D4D4;">(() </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#569CD6;">    import</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&#39;@micro-web/root-config&#39;</span><span style="color:#D4D4D4;">);</span></span>
<span class="line"><span style="color:#D4D4D4;">  });</span></span>
<span class="line"><span style="color:#808080;">&lt;/</span><span style="color:#569CD6;">script</span><span style="color:#808080;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki slack-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A9955;">// src/micro-web-root-config.js</span></span>
<span class="line"><span style="color:#DCDCAA;">registerApplication</span><span style="color:#E6E6E6;">({</span></span>
<span class="line"><span style="color:#9CDCFE;">  name:</span><span style="color:#CE9178;"> &quot;@single-spa/welcome&quot;</span><span style="color:#E6E6E6;">,</span></span>
<span class="line"><span style="color:#DCDCAA;">  app</span><span style="color:#9CDCFE;">:</span><span style="color:#E6E6E6;"> () </span><span style="color:#569CD6;">=&gt;</span></span>
<span class="line"><span style="color:#DCDCAA;">    import</span><span style="color:#E6E6E6;">(</span></span>
<span class="line"><span style="color:#6A9955;">      /* webpackIgnore: true */</span><span style="color:#6A9955;"> // @ts-ignore-next</span></span>
<span class="line"><span style="color:#CE9178;">      &quot;https://unpkg.com/single-spa-welcome/dist/single-spa-welcome.js&quot;</span></span>
<span class="line"><span style="color:#E6E6E6;">    ),</span></span>
<span class="line"><span style="color:#DCDCAA;">  activeWhen</span><span style="color:#9CDCFE;">:</span><span style="color:#9CDCFE;"> location</span><span style="color:#569CD6;"> =&gt;</span><span style="color:#9CDCFE;"> location</span><span style="color:#E6E6E6;">.</span><span style="color:#9CDCFE;">pathname</span><span style="color:#D4D4D4;"> ===</span><span style="color:#CE9178;"> &quot;/&quot;</span><span style="color:#E6E6E6;">,</span></span>
<span class="line"><span style="color:#E6E6E6;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">// 启动基座</span></span>
<span class="line"><span style="color:#DCDCAA;">start</span><span style="color:#E6E6E6;">({</span></span>
<span class="line"><span style="color:#9CDCFE;">  urlRerouteOnly:</span><span style="color:#569CD6;"> true</span><span style="color:#E6E6E6;">,</span></span>
<span class="line"><span style="color:#E6E6E6;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>如果需要添加子应用需要在 <code>index.ejs</code> 增加子应用的链接，再进行导入。然后在 <code>root-config.js</code> 中注册。</p><blockquote><p>基座的加载的过程大致是，启动 index.ejs -&gt; 导入 @micro-web/root-config -&gt; 执行 root-config.js</p></blockquote><h3 id="vue3-子应用" tabindex="-1">Vue3 子应用 <a class="header-anchor" href="#vue3-子应用" aria-label="Permalink to &quot;Vue3 子应用&quot;">​</a></h3><p>考虑的子路由的切换，只需要在 <code>createWebHistory</code> 中传入 <code>base</code>。</p><p>成功后可能会出现 <code>Vue</code> 中的图片在主应用中不显示。解决方案如下。</p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki slack-dark vp-code" tabindex="0"><code><span class="line"><span>在主应用中的 &lt;meta http-equiv=&quot;Content-Security-Policy&quot;&gt;&lt;/meta&gt; content中加上 img-src &#39;self&#39; data:。</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>需要关注 <code>package.json</code> 中的两条启动命令，如下：</p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki slack-dark vp-code" tabindex="0"><code><span class="line"><span>// 集成基座启动</span></span>
<span class="line"><span>&quot;start&quot;: &quot;webpack serve&quot;,</span></span>
<span class="line"><span>// 单独启动</span></span>
<span class="line"><span>&quot;start:standalone&quot;: &quot;webpack serve --env standalone&quot;,</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>start</code> 启动后打开链接会关注 <code>How do I develop this microfrontend?</code> 的第一、第四步。复制链接和名称添加到基座中</p><div class="language-html line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki slack-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A9955;">&lt;!-- 基座 index.ejs --&gt;</span></span>
<span class="line"><span style="color:#808080;">&lt;</span><span style="color:#569CD6;">script</span><span style="color:#9CDCFE;"> type</span><span style="color:#D4D4D4;">=</span><span style="color:#CE9178;">&quot;injector-importmap&quot;</span><span style="color:#808080;">&gt;</span></span>
<span class="line"><span style="color:#D4D4D4;">  {</span></span>
<span class="line"><span style="color:#D4D4D4;">    &quot;imports&quot;: {</span></span>
<span class="line"><span style="color:#D4D4D4;">      &quot;@micro-web/root-config&quot;: &quot;//localhost:9000/micro-web-root-config.js&quot;,</span></span>
<span class="line"><span style="color:#D4D4D4;">      &quot;@single-spa/welcome&quot;: &quot;https://cdn.jsdelivr.net/npm/single-spa-welcome/dist/single-spa-welcome.min.js&quot;,</span></span>
<span class="line"><span style="color:#D4D4D4;">      &quot;@micro-web/xsq-vue-app&quot;: &quot;//localhost:3000/js/app.js&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#808080;">&lt;/</span><span style="color:#569CD6;">script</span><span style="color:#808080;">&gt;</span></span>
<span class="line"><span style="color:#808080;">&lt;</span><span style="color:#569CD6;">script</span><span style="color:#808080;">&gt;</span></span>
<span class="line"><span style="color:#9CDCFE;">  window</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">importMapInjector</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">initPromise</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">then</span><span style="color:#D4D4D4;">(() </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#569CD6;">    import</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&#39;@micro-web/root-config&#39;</span><span style="color:#D4D4D4;">);</span></span>
<span class="line"><span style="color:#569CD6;">    import</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&#39;@micro-web/xsq-vue-app&#39;</span><span style="color:#D4D4D4;">);</span></span>
<span class="line"><span style="color:#D4D4D4;">  });</span></span>
<span class="line"><span style="color:#808080;">&lt;/</span><span style="color:#569CD6;">script</span><span style="color:#808080;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki slack-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A9955;">// src/micro-web-root-config.js</span></span>
<span class="line"><span style="color:#DCDCAA;">registerApplication</span><span style="color:#E6E6E6;">({</span></span>
<span class="line"><span style="color:#9CDCFE;">  name:</span><span style="color:#CE9178;"> &quot;@single-spa/welcome&quot;</span><span style="color:#E6E6E6;">,</span></span>
<span class="line"><span style="color:#DCDCAA;">  app</span><span style="color:#9CDCFE;">:</span><span style="color:#E6E6E6;"> () </span><span style="color:#569CD6;">=&gt;</span></span>
<span class="line"><span style="color:#DCDCAA;">    import</span><span style="color:#E6E6E6;">(</span></span>
<span class="line"><span style="color:#6A9955;">      /* webpackIgnore: true */</span><span style="color:#6A9955;"> // @ts-ignore-next</span></span>
<span class="line"><span style="color:#CE9178;">      &quot;https://unpkg.com/single-spa-welcome/dist/single-spa-welcome.js&quot;</span></span>
<span class="line"><span style="color:#E6E6E6;">    ),</span></span>
<span class="line"><span style="color:#DCDCAA;">  activeWhen</span><span style="color:#9CDCFE;">:</span><span style="color:#9CDCFE;"> location</span><span style="color:#569CD6;"> =&gt;</span><span style="color:#9CDCFE;"> location</span><span style="color:#E6E6E6;">.</span><span style="color:#9CDCFE;">pathname</span><span style="color:#D4D4D4;"> ===</span><span style="color:#CE9178;"> &quot;/&quot;</span><span style="color:#E6E6E6;">,</span></span>
<span class="line"><span style="color:#E6E6E6;">});</span></span>
<span class="line"><span style="color:#DCDCAA;">registerApplication</span><span style="color:#E6E6E6;">({</span></span>
<span class="line"><span style="color:#9CDCFE;">  name:</span><span style="color:#CE9178;"> &quot;@micro-web/xsq-vue-app&quot;</span><span style="color:#E6E6E6;">,</span></span>
<span class="line"><span style="color:#DCDCAA;">  app</span><span style="color:#9CDCFE;">:</span><span style="color:#E6E6E6;"> () </span><span style="color:#569CD6;">=&gt;</span><span style="color:#569CD6;"> import</span><span style="color:#E6E6E6;">(</span><span style="color:#CE9178;">&quot;@micro-web/xsq-vue-app&quot;</span><span style="color:#E6E6E6;">),</span></span>
<span class="line"><span style="color:#6A9955;">  // createWebHistory base 路由</span></span>
<span class="line"><span style="color:#DCDCAA;">  activeWhen</span><span style="color:#9CDCFE;">:</span><span style="color:#9CDCFE;"> location</span><span style="color:#569CD6;"> =&gt;</span><span style="color:#9CDCFE;"> location</span><span style="color:#E6E6E6;">.</span><span style="color:#9CDCFE;">pathname</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">startsWith</span><span style="color:#E6E6E6;">(</span><span style="color:#CE9178;">&quot;/vue&quot;</span><span style="color:#E6E6E6;">),</span></span>
<span class="line"><span style="color:#E6E6E6;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="react-子应用" tabindex="-1">React 子应用 <a class="header-anchor" href="#react-子应用" aria-label="Permalink to &quot;React 子应用&quot;">​</a></h3><p>同样的需要在 <code>BrowserRouter</code> 中传入 <code>basename</code> 。使用 <code>start</code> 启动项目时，需要关注 <code>How do I develop this microfrontend?</code> 复制第一步的链接及第四步的名称添加到基座中。</p><div class="language-html line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki slack-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A9955;">&lt;!-- 基座 index.ejs --&gt;</span></span>
<span class="line"><span style="color:#808080;">&lt;</span><span style="color:#569CD6;">script</span><span style="color:#9CDCFE;"> type</span><span style="color:#D4D4D4;">=</span><span style="color:#CE9178;">&quot;injector-importmap&quot;</span><span style="color:#808080;">&gt;</span></span>
<span class="line"><span style="color:#D4D4D4;">  {</span></span>
<span class="line"><span style="color:#D4D4D4;">    &quot;imports&quot;: {</span></span>
<span class="line"><span style="color:#D4D4D4;">      &quot;@micro-web/root-config&quot;: &quot;//localhost:9000/micro-web-root-config.js&quot;,</span></span>
<span class="line"><span style="color:#D4D4D4;">      &quot;@single-spa/welcome&quot;: &quot;https://cdn.jsdelivr.net/npm/single-spa-welcome/dist/single-spa-welcome.min.js&quot;,</span></span>
<span class="line"><span style="color:#D4D4D4;">      &quot;@micro-web/xsq-react-app&quot;: &quot;//localhost:4000/js/app.js&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#808080;">&lt;/</span><span style="color:#569CD6;">script</span><span style="color:#808080;">&gt;</span></span>
<span class="line"><span style="color:#808080;">&lt;</span><span style="color:#569CD6;">script</span><span style="color:#808080;">&gt;</span></span>
<span class="line"><span style="color:#9CDCFE;">  window</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">importMapInjector</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">initPromise</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">then</span><span style="color:#D4D4D4;">(() </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#569CD6;">    import</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&#39;@micro-web/root-config&#39;</span><span style="color:#D4D4D4;">);</span></span>
<span class="line"><span style="color:#569CD6;">    import</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&#39;@micro-web/xsq-react-app&#39;</span><span style="color:#D4D4D4;">);</span></span>
<span class="line"><span style="color:#D4D4D4;">  });</span></span>
<span class="line"><span style="color:#808080;">&lt;/</span><span style="color:#569CD6;">script</span><span style="color:#808080;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki slack-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A9955;">// src/micro-web-root-config.js</span></span>
<span class="line"><span style="color:#DCDCAA;">registerApplication</span><span style="color:#E6E6E6;">({</span></span>
<span class="line"><span style="color:#9CDCFE;">  name:</span><span style="color:#CE9178;"> &quot;@single-spa/welcome&quot;</span><span style="color:#E6E6E6;">,</span></span>
<span class="line"><span style="color:#DCDCAA;">  app</span><span style="color:#9CDCFE;">:</span><span style="color:#E6E6E6;"> () </span><span style="color:#569CD6;">=&gt;</span></span>
<span class="line"><span style="color:#DCDCAA;">    import</span><span style="color:#E6E6E6;">(</span></span>
<span class="line"><span style="color:#6A9955;">      /* webpackIgnore: true */</span><span style="color:#6A9955;"> // @ts-ignore-next</span></span>
<span class="line"><span style="color:#CE9178;">      &quot;https://unpkg.com/single-spa-welcome/dist/single-spa-welcome.js&quot;</span></span>
<span class="line"><span style="color:#E6E6E6;">    ),</span></span>
<span class="line"><span style="color:#DCDCAA;">  activeWhen</span><span style="color:#9CDCFE;">:</span><span style="color:#9CDCFE;"> location</span><span style="color:#569CD6;"> =&gt;</span><span style="color:#9CDCFE;"> location</span><span style="color:#E6E6E6;">.</span><span style="color:#9CDCFE;">pathname</span><span style="color:#D4D4D4;"> ===</span><span style="color:#CE9178;"> &quot;/&quot;</span><span style="color:#E6E6E6;">,</span></span>
<span class="line"><span style="color:#E6E6E6;">});</span></span>
<span class="line"><span style="color:#DCDCAA;">registerApplication</span><span style="color:#E6E6E6;">({</span></span>
<span class="line"><span style="color:#9CDCFE;">  name:</span><span style="color:#CE9178;"> &quot;@micro-web/xsq-react-app&quot;</span><span style="color:#E6E6E6;">,</span></span>
<span class="line"><span style="color:#DCDCAA;">  app</span><span style="color:#9CDCFE;">:</span><span style="color:#E6E6E6;"> () </span><span style="color:#569CD6;">=&gt;</span><span style="color:#569CD6;"> import</span><span style="color:#E6E6E6;">(</span><span style="color:#CE9178;">&quot;@micro-web/xsq-react-app&quot;</span><span style="color:#E6E6E6;">),</span></span>
<span class="line"><span style="color:#6A9955;">  // BrowserRouter base 路由</span></span>
<span class="line"><span style="color:#DCDCAA;">  activeWhen</span><span style="color:#9CDCFE;">:</span><span style="color:#9CDCFE;"> location</span><span style="color:#569CD6;"> =&gt;</span><span style="color:#9CDCFE;"> location</span><span style="color:#E6E6E6;">.</span><span style="color:#9CDCFE;">pathname</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">startsWith</span><span style="color:#E6E6E6;">(</span><span style="color:#CE9178;">&quot;/react&quot;</span><span style="color:#E6E6E6;">),</span></span>
<span class="line"><span style="color:#E6E6E6;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="single-spa-原理" tabindex="-1">single-spa 原理 <a class="header-anchor" href="#single-spa-原理" aria-label="Permalink to &quot;single-spa 原理&quot;">​</a></h2><p>首先看 <code>demo</code> 中的 <code>registerApplication</code> 一共就三个参数，实际上还有第四个参数 <code>props</code> 可以用来主子应用之间的数据传递。然后每个应用中都会包含自己的生命周期函数。可以简化成如下代码：</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki slack-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#569CD6;">const</span><span style="color:#9CDCFE;"> app_a</span><span style="color:#D4D4D4;"> =</span><span style="color:#E6E6E6;"> {</span></span>
<span class="line"><span style="color:#DCDCAA;">  bootstrap</span><span style="color:#9CDCFE;">:</span><span style="color:#569CD6;"> async</span><span style="color:#E6E6E6;"> () </span><span style="color:#569CD6;">=&gt;</span><span style="color:#9CDCFE;"> console</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">log</span><span style="color:#E6E6E6;">(</span><span style="color:#CE9178;">&#39;app_a bootstrap ~~~&#39;</span><span style="color:#E6E6E6;">),</span></span>
<span class="line"><span style="color:#6A9955;">  // 生命周期可以允许有多个</span></span>
<span class="line"><span style="color:#9CDCFE;">  mount:</span><span style="color:#E6E6E6;"> [</span></span>
<span class="line"><span style="color:#569CD6;">    async</span><span style="color:#E6E6E6;"> () </span><span style="color:#569CD6;">=&gt;</span><span style="color:#9CDCFE;"> console</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">log</span><span style="color:#E6E6E6;">(</span><span style="color:#CE9178;">&#39;app_a mount 1 ~~~&#39;</span><span style="color:#E6E6E6;">),</span></span>
<span class="line"><span style="color:#569CD6;">    async</span><span style="color:#E6E6E6;"> () </span><span style="color:#569CD6;">=&gt;</span><span style="color:#9CDCFE;"> console</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">log</span><span style="color:#E6E6E6;">(</span><span style="color:#CE9178;">&#39;app_a mount 2 ~~~&#39;</span><span style="color:#E6E6E6;">),</span></span>
<span class="line"><span style="color:#E6E6E6;">  ],</span></span>
<span class="line"><span style="color:#DCDCAA;">  unmount</span><span style="color:#9CDCFE;">:</span><span style="color:#569CD6;"> async</span><span style="color:#E6E6E6;"> () </span><span style="color:#569CD6;">=&gt;</span><span style="color:#9CDCFE;"> console</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">log</span><span style="color:#E6E6E6;">(</span><span style="color:#CE9178;">&#39;app_a unmount ~~~&#39;</span><span style="color:#E6E6E6;">)</span></span>
<span class="line"><span style="color:#E6E6E6;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">// 创建两个子应用，方便测试 启动 -&gt; 挂载 -&gt; 卸载 的流程</span></span>
<span class="line"><span style="color:#569CD6;">const</span><span style="color:#9CDCFE;"> app_b</span><span style="color:#D4D4D4;"> =</span><span style="color:#E6E6E6;"> {</span></span>
<span class="line"><span style="color:#DCDCAA;">  bootstrap</span><span style="color:#9CDCFE;">:</span><span style="color:#569CD6;"> async</span><span style="color:#E6E6E6;"> () </span><span style="color:#569CD6;">=&gt;</span><span style="color:#9CDCFE;"> console</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">log</span><span style="color:#E6E6E6;">(</span><span style="color:#CE9178;">&#39;app_b bootstrap ~~~&#39;</span><span style="color:#E6E6E6;">),</span></span>
<span class="line"><span style="color:#9CDCFE;">  mount:</span><span style="color:#E6E6E6;"> [</span></span>
<span class="line"><span style="color:#569CD6;">    async</span><span style="color:#E6E6E6;"> () </span><span style="color:#569CD6;">=&gt;</span><span style="color:#9CDCFE;"> console</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">log</span><span style="color:#E6E6E6;">(</span><span style="color:#CE9178;">&#39;app_b mount 1 ~~~&#39;</span><span style="color:#E6E6E6;">),</span></span>
<span class="line"><span style="color:#569CD6;">    async</span><span style="color:#E6E6E6;"> () </span><span style="color:#569CD6;">=&gt;</span><span style="color:#9CDCFE;"> console</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">log</span><span style="color:#E6E6E6;">(</span><span style="color:#CE9178;">&#39;app_b mount 2 ~~~&#39;</span><span style="color:#E6E6E6;">),</span></span>
<span class="line"><span style="color:#E6E6E6;">  ],</span></span>
<span class="line"><span style="color:#DCDCAA;">  unmount</span><span style="color:#9CDCFE;">:</span><span style="color:#569CD6;"> async</span><span style="color:#E6E6E6;"> () </span><span style="color:#569CD6;">=&gt;</span><span style="color:#9CDCFE;"> console</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">log</span><span style="color:#E6E6E6;">(</span><span style="color:#CE9178;">&#39;app_b unmount ~~~&#39;</span><span style="color:#E6E6E6;">)</span></span>
<span class="line"><span style="color:#E6E6E6;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">/**</span></span>
<span class="line"><span style="color:#6A9955;"> * 注册应用，看路径是否匹配，如果匹配就加载对应的文件</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#4EC9B0;"> {*}</span><span style="color:#9CDCFE;"> appName</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#4EC9B0;"> {*}</span><span style="color:#9CDCFE;"> App</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#4EC9B0;"> {*}</span><span style="color:#9CDCFE;"> activeWhen</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#4EC9B0;"> {*}</span><span style="color:#9CDCFE;"> customProps</span></span>
<span class="line"><span style="color:#6A9955;"> */</span></span>
<span class="line"><span style="color:#DCDCAA;">registerApplication</span><span style="color:#E6E6E6;">(</span><span style="color:#CE9178;">&#39;a&#39;</span><span style="color:#E6E6E6;">, </span><span style="color:#569CD6;">async</span><span style="color:#E6E6E6;"> () </span><span style="color:#569CD6;">=&gt;</span><span style="color:#9CDCFE;"> app_a</span><span style="color:#E6E6E6;">, </span><span style="color:#9CDCFE;">location</span><span style="color:#569CD6;"> =&gt;</span><span style="color:#9CDCFE;"> location</span><span style="color:#E6E6E6;">.</span><span style="color:#9CDCFE;">pathname</span><span style="color:#D4D4D4;"> ===</span><span style="color:#CE9178;"> &#39;#/a&#39;</span><span style="color:#E6E6E6;">, { </span><span style="color:#9CDCFE;">a:</span><span style="color:#B5CEA8;"> 1</span><span style="color:#E6E6E6;"> });</span></span>
<span class="line"><span style="color:#DCDCAA;">registerApplication</span><span style="color:#E6E6E6;">(</span><span style="color:#CE9178;">&#39;b&#39;</span><span style="color:#E6E6E6;">, </span><span style="color:#569CD6;">async</span><span style="color:#E6E6E6;"> () </span><span style="color:#569CD6;">=&gt;</span><span style="color:#9CDCFE;"> app_b</span><span style="color:#E6E6E6;">, </span><span style="color:#9CDCFE;">location</span><span style="color:#569CD6;"> =&gt;</span><span style="color:#9CDCFE;"> location</span><span style="color:#E6E6E6;">.</span><span style="color:#9CDCFE;">pathname</span><span style="color:#D4D4D4;"> ===</span><span style="color:#CE9178;"> &#39;#/b&#39;</span><span style="color:#E6E6E6;">, { </span><span style="color:#9CDCFE;">b:</span><span style="color:#B5CEA8;"> 2</span><span style="color:#E6E6E6;"> });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">// 开启路径监控，路径切换的时候，可以调用对应的 mount unmount</span></span>
<span class="line"><span style="color:#DCDCAA;">start</span><span style="color:#E6E6E6;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>在内部将应用的生命周期分为如下部分：在最开始的时候给 <code>app</code> 增加 <code>status</code> 属性全是 <code>NOT_LOADED</code>，随着后续的执行，一步步的更新状态。</p><p><img src="`+o+`" alt="single-spa"></p><p>源码组织方式</p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki slack-dark vp-code" tabindex="0"><code><span class="line"><span>.</span></span>
<span class="line"><span>├── application  注册，状态维护，及对于 app 状态的分类</span></span>
<span class="line"><span>│   ├── app-helper.js</span></span>
<span class="line"><span>│   └── app.js</span></span>
<span class="line"><span>├── lifecycles  生命周期</span></span>
<span class="line"><span>│   ├── load.js</span></span>
<span class="line"><span>│   ├── bootstrap.js</span></span>
<span class="line"><span>│   ├── mount.js</span></span>
<span class="line"><span>│   └── unmount.js</span></span>
<span class="line"><span>├── navigation  导航路由相关</span></span>
<span class="line"><span>│   ├── navigate-event.js</span></span>
<span class="line"><span>│   └── reroute.js</span></span>
<span class="line"><span>├── single-spa.js  入口文件</span></span>
<span class="line"><span>└── start.js  启动子应用的入口文件</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="vp-code-group"><div class="tabs"><input type="radio" name="group-n3kga" id="tab-Fz4b02M" checked><label data-title="single-spa.js" for="tab-Fz4b02M">single-spa.js</label><input type="radio" name="group-n3kga" id="tab-3R8R6rT"><label data-title="application/app.js" for="tab-3R8R6rT">application/app.js</label></div><div class="blocks"><div class="language-js active line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki slack-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A9955;">// 根据路径加载应用</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#E6E6E6;"> { </span><span style="color:#9CDCFE;">registerApplication</span><span style="color:#E6E6E6;"> } </span><span style="color:#C586C0;">from</span><span style="color:#CE9178;"> &#39;./application/app.js&#39;</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#6A9955;">// 开启应用，挂载组件</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#E6E6E6;"> { </span><span style="color:#9CDCFE;">start</span><span style="color:#E6E6E6;"> } </span><span style="color:#C586C0;">from</span><span style="color:#CE9178;"> &#39;./start.js&#39;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki slack-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#C586C0;">import</span><span style="color:#E6E6E6;"> { </span><span style="color:#9CDCFE;">NOT_LOADED</span><span style="color:#E6E6E6;"> } </span><span style="color:#C586C0;">from</span><span style="color:#CE9178;"> &#39;./app-helper.js&#39;</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#C586C0;">import</span><span style="color:#E6E6E6;"> { </span><span style="color:#9CDCFE;">reroute</span><span style="color:#E6E6E6;"> } </span><span style="color:#C586C0;">from</span><span style="color:#CE9178;"> &#39;../navigate/reroute.js&#39;</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#569CD6;"> const</span><span style="color:#9CDCFE;"> apps</span><span style="color:#D4D4D4;"> =</span><span style="color:#E6E6E6;"> []; </span><span style="color:#6A9955;">// 维护一个全局的 app 数组</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#569CD6;"> function</span><span style="color:#DCDCAA;"> registerApplication</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">appName</span><span style="color:#E6E6E6;">, </span><span style="color:#9CDCFE;">loadApp</span><span style="color:#E6E6E6;">, </span><span style="color:#9CDCFE;">activeWhen</span><span style="color:#E6E6E6;">, </span><span style="color:#9CDCFE;">customProps</span><span style="color:#E6E6E6;">) {</span></span>
<span class="line"><span style="color:#569CD6;">  const</span><span style="color:#9CDCFE;"> registeration</span><span style="color:#D4D4D4;"> =</span><span style="color:#E6E6E6;"> {</span></span>
<span class="line"><span style="color:#9CDCFE;">    name:</span><span style="color:#9CDCFE;"> appName</span><span style="color:#E6E6E6;">,</span></span>
<span class="line"><span style="color:#9CDCFE;">    loadApp</span><span style="color:#E6E6E6;">,</span></span>
<span class="line"><span style="color:#9CDCFE;">    activeWhen</span><span style="color:#E6E6E6;">,</span></span>
<span class="line"><span style="color:#9CDCFE;">    customProps</span><span style="color:#E6E6E6;">,</span></span>
<span class="line"><span style="color:#9CDCFE;">    status:</span><span style="color:#9CDCFE;"> NOT_LOADED</span></span>
<span class="line"><span style="color:#E6E6E6;">  };</span></span>
<span class="line"><span style="color:#9CDCFE;">  apps</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">push</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">registeration</span><span style="color:#E6E6E6;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">  // 先去加载需要被加载的应用，如果是挂载过的应用，需要现将挂载过的卸载掉，然后再去挂载新的应用</span></span>
<span class="line"><span style="color:#DCDCAA;">  reroute</span><span style="color:#E6E6E6;">(); </span><span style="color:#6A9955;">// 重写路由</span></span>
<span class="line"><span style="color:#E6E6E6;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div></div></div><p>定义应用的状态，根据状态进行分类然后抛出，方便后续的启动，加载，卸载，挂载等操作。</p><div class="vp-code-group"><div class="tabs"><input type="radio" name="group-lloj4" id="tab-rFfyCLx" checked><label data-title="application/app-helper.js" for="tab-rFfyCLx">application/app-helper.js</label></div><div class="blocks"><div class="language-js active line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki slack-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A9955;">// 加载流程</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#569CD6;"> const</span><span style="color:#9CDCFE;"> NOT_LOADED</span><span style="color:#D4D4D4;"> =</span><span style="color:#CE9178;"> &#39;NOT_LOADED&#39;</span><span style="color:#E6E6E6;">; </span><span style="color:#6A9955;">// 没有被加载</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#569CD6;"> const</span><span style="color:#9CDCFE;"> LOADING_SOURCE_CODE</span><span style="color:#D4D4D4;"> =</span><span style="color:#CE9178;"> &#39;LOADING_SOURCE_CODE&#39;</span><span style="color:#E6E6E6;">; </span><span style="color:#6A9955;">// 路径匹配后加载应用</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#569CD6;"> const</span><span style="color:#9CDCFE;"> LOAD_ERROR</span><span style="color:#D4D4D4;"> =</span><span style="color:#CE9178;"> &#39;LOAD_ERROR&#39;</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">// 启动流程</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#569CD6;"> const</span><span style="color:#9CDCFE;"> NOT_BOOTSTRAPPED</span><span style="color:#D4D4D4;"> =</span><span style="color:#CE9178;"> &#39;NOT_BOOTSTRAPPED&#39;</span><span style="color:#E6E6E6;">; </span><span style="color:#6A9955;">// 资源加载完毕，需要启动</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#569CD6;"> const</span><span style="color:#9CDCFE;"> BOOTSTRAPING</span><span style="color:#D4D4D4;"> =</span><span style="color:#CE9178;"> &#39;BOOTSTRAPING&#39;</span><span style="color:#E6E6E6;">; </span><span style="color:#6A9955;">// 启动中</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#569CD6;"> const</span><span style="color:#9CDCFE;"> NOT_MOUNT</span><span style="color:#D4D4D4;"> =</span><span style="color:#CE9178;"> &#39;NOT_MOUNT&#39;</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">// 挂载流程</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#569CD6;"> const</span><span style="color:#9CDCFE;"> MOUNTING</span><span style="color:#D4D4D4;"> =</span><span style="color:#CE9178;"> &#39;MOUNTING&#39;</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#569CD6;"> const</span><span style="color:#9CDCFE;"> MOUNTED</span><span style="color:#D4D4D4;"> =</span><span style="color:#CE9178;"> &#39;MOUNTED&#39;</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">// 卸载流程</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#569CD6;"> const</span><span style="color:#9CDCFE;"> UNMOUNTING</span><span style="color:#D4D4D4;"> =</span><span style="color:#CE9178;"> &#39;UNMOUNTING&#39;</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">// --- 增加一些工具方法</span></span>
<span class="line"><span style="color:#6A9955;">// 子应用是否被激活</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#569CD6;"> const</span><span style="color:#DCDCAA;"> shouldBeActive</span><span style="color:#D4D4D4;"> =</span><span style="color:#E6E6E6;"> (</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">) </span><span style="color:#569CD6;">=&gt;</span><span style="color:#9CDCFE;"> app</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">activeWhen</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">window</span><span style="color:#E6E6E6;">.</span><span style="color:#9CDCFE;">location</span><span style="color:#E6E6E6;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">// 根据 app 的状态进行分类</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#569CD6;"> function</span><span style="color:#DCDCAA;"> getAppChanges</span><span style="color:#E6E6E6;">() {</span></span>
<span class="line"><span style="color:#569CD6;">  const</span><span style="color:#9CDCFE;"> appsToLoad</span><span style="color:#D4D4D4;"> =</span><span style="color:#E6E6E6;"> [];</span></span>
<span class="line"><span style="color:#569CD6;">  const</span><span style="color:#9CDCFE;"> appsToMount</span><span style="color:#D4D4D4;"> =</span><span style="color:#E6E6E6;"> [];</span></span>
<span class="line"><span style="color:#569CD6;">  const</span><span style="color:#9CDCFE;"> appsToUnmount</span><span style="color:#D4D4D4;"> =</span><span style="color:#E6E6E6;"> [];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9CDCFE;">  apps</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">forEach</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">app</span><span style="color:#569CD6;"> =&gt;</span><span style="color:#E6E6E6;"> {</span></span>
<span class="line"><span style="color:#C586C0;">    switch</span><span style="color:#E6E6E6;"> (</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">.</span><span style="color:#9CDCFE;">status</span><span style="color:#E6E6E6;">) {</span></span>
<span class="line"><span style="color:#C586C0;">      case</span><span style="color:#9CDCFE;"> NOT_LOADED</span><span style="color:#E6E6E6;">:</span></span>
<span class="line"><span style="color:#C586C0;">      case</span><span style="color:#9CDCFE;"> LOADING_SOURCE_CODE</span><span style="color:#E6E6E6;">:</span></span>
<span class="line"><span style="color:#C586C0;">        if</span><span style="color:#E6E6E6;"> (</span><span style="color:#DCDCAA;">shouldBeActive</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">)) {</span></span>
<span class="line"><span style="color:#9CDCFE;">          appsToLoad</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">push</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">);</span></span>
<span class="line"><span style="color:#E6E6E6;">        }</span></span>
<span class="line"><span style="color:#C586C0;">        break</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#C586C0;">      case</span><span style="color:#9CDCFE;"> NOT_BOOTSTRAPED</span><span style="color:#E6E6E6;">:</span></span>
<span class="line"><span style="color:#C586C0;">      case</span><span style="color:#9CDCFE;"> BOOTSTRAPING</span><span style="color:#E6E6E6;">:</span></span>
<span class="line"><span style="color:#C586C0;">      case</span><span style="color:#9CDCFE;"> NOT_MOUNT</span><span style="color:#E6E6E6;">:</span></span>
<span class="line"><span style="color:#C586C0;">        if</span><span style="color:#E6E6E6;"> (</span><span style="color:#DCDCAA;">shouldBeActive</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">)) {</span></span>
<span class="line"><span style="color:#9CDCFE;">          appsToMount</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">push</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">);</span></span>
<span class="line"><span style="color:#E6E6E6;">        }</span></span>
<span class="line"><span style="color:#C586C0;">        break</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#C586C0;">      case</span><span style="color:#9CDCFE;"> MOUNTED</span><span style="color:#E6E6E6;">:</span></span>
<span class="line"><span style="color:#6A9955;">        // 是 mount 但是路径变了，要准备卸载了。</span></span>
<span class="line"><span style="color:#C586C0;">        if</span><span style="color:#E6E6E6;"> (</span><span style="color:#D4D4D4;">!</span><span style="color:#DCDCAA;">shouldBeActive</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">)) {</span></span>
<span class="line"><span style="color:#9CDCFE;">          appsToUnmount</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">push</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">);</span></span>
<span class="line"><span style="color:#E6E6E6;">        }</span></span>
<span class="line"><span style="color:#C586C0;">        break</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#E6E6E6;">    }</span></span>
<span class="line"><span style="color:#E6E6E6;">  });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C586C0;">  return</span><span style="color:#E6E6E6;"> { </span><span style="color:#9CDCFE;">appsToLoad</span><span style="color:#E6E6E6;">, </span><span style="color:#9CDCFE;">appsToMount</span><span style="color:#E6E6E6;">, </span><span style="color:#9CDCFE;">appsToUnmount</span><span style="color:#E6E6E6;"> };</span></span>
<span class="line"><span style="color:#E6E6E6;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div></div></div><p>分析加载流程：</p><p>内部实际也是看用户传递的 <code>activeWhen</code> 看匹配到了哪个子应用，然后走加载逻辑，从 <code>shouldBeActive</code> 可以体现出来。</p><p>调用 <code>start</code> 方法，进入流程，内部会维护一个 <code>started</code> 变量确定是否加载完成，然后调用 <code>reroute</code> 方法。</p><div class="vp-code-group"><div class="tabs"><input type="radio" name="group-c-m1y" id="tab-n2sxzE7" checked><label data-title="start.js" for="tab-n2sxzE7">start.js</label><input type="radio" name="group-c-m1y" id="tab-c-Ph2mR"><label data-title="navigate/reroute.js" for="tab-c-Ph2mR">navigate/reroute.js</label></div><div class="blocks"><div class="language-js active line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki slack-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#C586C0;">import</span><span style="color:#E6E6E6;"> { </span><span style="color:#9CDCFE;">reroute</span><span style="color:#E6E6E6;"> } </span><span style="color:#C586C0;">from</span><span style="color:#CE9178;"> &#39;../navigate/reroute.js&#39;</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#569CD6;"> let</span><span style="color:#9CDCFE;"> started</span><span style="color:#D4D4D4;"> =</span><span style="color:#569CD6;"> false</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#569CD6;"> function</span><span style="color:#DCDCAA;"> start</span><span style="color:#E6E6E6;">() {</span></span>
<span class="line"><span style="color:#9CDCFE;">  started</span><span style="color:#D4D4D4;"> =</span><span style="color:#569CD6;"> true</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#DCDCAA;">  reroute</span><span style="color:#E6E6E6;">();</span></span>
<span class="line"><span style="color:#E6E6E6;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki slack-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#C586C0;">import</span><span style="color:#E6E6E6;"> { </span><span style="color:#9CDCFE;">getAppChanges</span><span style="color:#E6E6E6;">, </span><span style="color:#9CDCFE;">shouldBeActive</span><span style="color:#E6E6E6;"> } </span><span style="color:#C586C0;">from</span><span style="color:#CE9178;"> &#39;../application/app-helper.js&#39;</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#C586C0;">import</span><span style="color:#E6E6E6;"> { </span><span style="color:#9CDCFE;">toLoadPromise</span><span style="color:#E6E6E6;"> } </span><span style="color:#C586C0;">from</span><span style="color:#CE9178;"> &#39;../lifecycles/load.js&#39;</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#C586C0;">import</span><span style="color:#E6E6E6;"> { </span><span style="color:#9CDCFE;">started</span><span style="color:#E6E6E6;"> } </span><span style="color:#C586C0;">from</span><span style="color:#CE9178;"> &#39;../start.js&#39;</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#569CD6;"> function</span><span style="color:#DCDCAA;"> reroute</span><span style="color:#E6E6E6;">() {</span></span>
<span class="line"><span style="color:#569CD6;">  const</span><span style="color:#E6E6E6;"> { </span><span style="color:#9CDCFE;">appsToLoad</span><span style="color:#E6E6E6;">, </span><span style="color:#9CDCFE;">appsToMount</span><span style="color:#E6E6E6;">, </span><span style="color:#9CDCFE;">appsToUnmount</span><span style="color:#E6E6E6;"> } </span><span style="color:#D4D4D4;">=</span><span style="color:#DCDCAA;"> getAppChanges</span><span style="color:#E6E6E6;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C586C0;">  if</span><span style="color:#E6E6E6;"> (</span><span style="color:#9CDCFE;">started</span><span style="color:#E6E6E6;">) {</span></span>
<span class="line"><span style="color:#6A9955;">    // 待实现</span></span>
<span class="line"><span style="color:#C586C0;">    return</span><span style="color:#DCDCAA;"> performAppChange</span><span style="color:#E6E6E6;">();</span></span>
<span class="line"><span style="color:#E6E6E6;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">  function</span><span style="color:#DCDCAA;"> loadApps</span><span style="color:#E6E6E6;">() {</span></span>
<span class="line"><span style="color:#C586C0;">    return</span><span style="color:#4EC9B0;"> Promise</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">all</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">appsToLoad</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">map</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">app</span><span style="color:#569CD6;"> =&gt;</span><span style="color:#DCDCAA;"> toLoadPromise</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">)));</span></span>
<span class="line"><span style="color:#E6E6E6;">  }</span></span>
<span class="line"><span style="color:#C586C0;">  return</span><span style="color:#DCDCAA;"> loadApps</span><span style="color:#E6E6E6;">();</span></span>
<span class="line"><span style="color:#E6E6E6;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div></div></div><p><code>reroute</code> 在 <code>registerApplication</code> 和 <code>start</code> 中分别调用了一次。注册的时候直接走 <code>loadApps</code> 加载逻辑；<code>start</code> 的时候走挂载流程。</p><div class="vp-code-group"><div class="tabs"><input type="radio" name="group-kp0HY" id="tab-My26k6X" checked><label data-title="lifecycles/load.js" for="tab-My26k6X">lifecycles/load.js</label></div><div class="blocks"><div class="language-js active line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki slack-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#C586C0;">import</span><span style="color:#E6E6E6;"> { </span><span style="color:#9CDCFE;">NOT_LOADED</span><span style="color:#E6E6E6;">, </span><span style="color:#9CDCFE;">LOADING_SOURCE_CODE</span><span style="color:#E6E6E6;">, </span><span style="color:#9CDCFE;">NOT_BOOTSTRAPED</span><span style="color:#E6E6E6;"> } </span><span style="color:#C586C0;">from</span><span style="color:#CE9178;"> &#39;../application/app-helper.js&#39;</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">const</span><span style="color:#DCDCAA;"> flattenArrayToPromise</span><span style="color:#D4D4D4;"> =</span><span style="color:#E6E6E6;"> (</span><span style="color:#9CDCFE;">fns</span><span style="color:#E6E6E6;">) </span><span style="color:#569CD6;">=&gt;</span><span style="color:#E6E6E6;"> {</span></span>
<span class="line"><span style="color:#9CDCFE;">  fns</span><span style="color:#D4D4D4;"> =</span><span style="color:#569CD6;"> typeof</span><span style="color:#9CDCFE;"> fns</span><span style="color:#D4D4D4;"> ===</span><span style="color:#CE9178;"> &#39;function&#39;</span><span style="color:#D4D4D4;"> ?</span><span style="color:#E6E6E6;"> [</span><span style="color:#9CDCFE;">fns</span><span style="color:#E6E6E6;">] </span><span style="color:#D4D4D4;">:</span><span style="color:#9CDCFE;"> fns</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#E6E6E6;">  </span></span>
<span class="line"><span style="color:#C586C0;">  return</span><span style="color:#E6E6E6;"> (</span><span style="color:#9CDCFE;">props</span><span style="color:#E6E6E6;">) </span><span style="color:#569CD6;">=&gt;</span><span style="color:#E6E6E6;"> {</span></span>
<span class="line"><span style="color:#6A9955;">    // 执行用户传递进来的生命周期</span></span>
<span class="line"><span style="color:#C586C0;">    return</span><span style="color:#9CDCFE;"> fns</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">reduce</span><span style="color:#E6E6E6;">((</span><span style="color:#9CDCFE;">rPromise</span><span style="color:#E6E6E6;">, </span><span style="color:#9CDCFE;">fn</span><span style="color:#E6E6E6;">) </span><span style="color:#569CD6;">=&gt;</span><span style="color:#9CDCFE;"> rPromise</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">then</span><span style="color:#E6E6E6;">(() </span><span style="color:#569CD6;">=&gt;</span><span style="color:#DCDCAA;"> fn</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">props</span><span style="color:#E6E6E6;">)), </span><span style="color:#4EC9B0;">Promise</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">resolve</span><span style="color:#E6E6E6;">());</span></span>
<span class="line"><span style="color:#E6E6E6;">  }</span></span>
<span class="line"><span style="color:#E6E6E6;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#569CD6;"> function</span><span style="color:#DCDCAA;"> toLoadPromise</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">) {</span></span>
<span class="line"><span style="color:#C586C0;">  return</span><span style="color:#4EC9B0;"> Promise</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">resolve</span><span style="color:#E6E6E6;">().</span><span style="color:#DCDCAA;">then</span><span style="color:#E6E6E6;">(() </span><span style="color:#569CD6;">=&gt;</span><span style="color:#E6E6E6;"> {</span></span>
<span class="line"><span style="color:#6A9955;">    // 不是 NOT_LOADED 表示加载完毕。</span></span>
<span class="line"><span style="color:#C586C0;">    if</span><span style="color:#E6E6E6;"> (</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">.</span><span style="color:#9CDCFE;">status</span><span style="color:#D4D4D4;"> !==</span><span style="color:#9CDCFE;"> NOT_LOADED</span><span style="color:#E6E6E6;">) {</span></span>
<span class="line"><span style="color:#C586C0;">      return</span><span style="color:#9CDCFE;"> app</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#E6E6E6;">    };</span></span>
<span class="line"><span style="color:#9CDCFE;">    app</span><span style="color:#E6E6E6;">.</span><span style="color:#9CDCFE;">status</span><span style="color:#D4D4D4;"> =</span><span style="color:#9CDCFE;"> LOADING_SOURCE_CODE</span><span style="color:#E6E6E6;">; </span><span style="color:#6A9955;">// 正在加载</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C586C0;">    return</span><span style="color:#9CDCFE;"> app</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">loadApp</span><span style="color:#E6E6E6;">().</span><span style="color:#DCDCAA;">then</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">v</span><span style="color:#569CD6;"> =&gt;</span><span style="color:#E6E6E6;"> {</span></span>
<span class="line"><span style="color:#569CD6;">      const</span><span style="color:#E6E6E6;"> { </span><span style="color:#9CDCFE;">bootstrap</span><span style="color:#E6E6E6;">, </span><span style="color:#9CDCFE;">mount</span><span style="color:#E6E6E6;">, </span><span style="color:#9CDCFE;">unmount</span><span style="color:#E6E6E6;"> } </span><span style="color:#D4D4D4;">=</span><span style="color:#9CDCFE;"> v</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#9CDCFE;">      app</span><span style="color:#E6E6E6;">.</span><span style="color:#9CDCFE;">status</span><span style="color:#D4D4D4;"> =</span><span style="color:#9CDCFE;"> NOT_BOOTSTRAPED</span></span>
<span class="line"><span style="color:#6A9955;">      // 注意：只是整合，还没有执行...</span></span>
<span class="line"><span style="color:#9CDCFE;">      app</span><span style="color:#E6E6E6;">.</span><span style="color:#9CDCFE;">bootstrap</span><span style="color:#D4D4D4;"> =</span><span style="color:#DCDCAA;"> flattenArrayToPromise</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">bootstrap</span><span style="color:#E6E6E6;">);</span></span>
<span class="line"><span style="color:#9CDCFE;">      app</span><span style="color:#E6E6E6;">.</span><span style="color:#9CDCFE;">mount</span><span style="color:#D4D4D4;"> =</span><span style="color:#DCDCAA;"> flattenArrayToPromise</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">mount</span><span style="color:#E6E6E6;">);</span></span>
<span class="line"><span style="color:#9CDCFE;">      app</span><span style="color:#E6E6E6;">.</span><span style="color:#9CDCFE;">unmount</span><span style="color:#D4D4D4;"> =</span><span style="color:#DCDCAA;"> flattenArrayToPromise</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">unmount</span><span style="color:#E6E6E6;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C586C0;">      return</span><span style="color:#9CDCFE;"> app</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#E6E6E6;">    });</span></span>
<span class="line"><span style="color:#E6E6E6;">  });</span></span>
<span class="line"><span style="color:#E6E6E6;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div></div></div><p><code>start</code> 方法开始调用，将 <code>started</code> 设置为 <code>true</code>，继续调用 <code>reroute</code> 方法走 <code>performAppChange</code> 分支。</p><div class="vp-code-group"><div class="tabs"><input type="radio" name="group-W9cws" id="tab-oYHhLFI" checked><label data-title="navigate/reroute.js" for="tab-oYHhLFI">navigate/reroute.js</label></div><div class="blocks"><div class="language-js active line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki slack-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#C586C0;">import</span><span style="color:#E6E6E6;"> { </span><span style="color:#9CDCFE;">getAppChanges</span><span style="color:#E6E6E6;">, </span><span style="color:#9CDCFE;">shouldBeActive</span><span style="color:#E6E6E6;"> } </span><span style="color:#C586C0;">from</span><span style="color:#CE9178;"> &quot;../application/app-helper.js&quot;</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#C586C0;">import</span><span style="color:#E6E6E6;"> { </span><span style="color:#9CDCFE;">toMountPromise</span><span style="color:#E6E6E6;"> } </span><span style="color:#C586C0;">from</span><span style="color:#CE9178;"> &#39;../lifecycles/mount.js&#39;</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#C586C0;">import</span><span style="color:#E6E6E6;"> { </span><span style="color:#9CDCFE;">toUnmountPromise</span><span style="color:#E6E6E6;"> } </span><span style="color:#C586C0;">from</span><span style="color:#CE9178;"> &#39;../lifecycles/unmount.js&#39;</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#C586C0;">import</span><span style="color:#E6E6E6;"> { </span><span style="color:#9CDCFE;">toBootstrapPromise</span><span style="color:#E6E6E6;"> } </span><span style="color:#C586C0;">from</span><span style="color:#CE9178;"> &#39;../lifecycles/bootstrap.js&#39;</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#C586C0;">import</span><span style="color:#E6E6E6;"> { </span><span style="color:#9CDCFE;">started</span><span style="color:#E6E6E6;"> } </span><span style="color:#C586C0;">from</span><span style="color:#CE9178;"> &quot;../start.js&quot;</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#569CD6;"> function</span><span style="color:#DCDCAA;"> reroute</span><span style="color:#E6E6E6;">() {</span></span>
<span class="line"><span style="color:#569CD6;">  const</span><span style="color:#E6E6E6;"> { </span><span style="color:#9CDCFE;">appsToLoad</span><span style="color:#E6E6E6;">, </span><span style="color:#9CDCFE;">appsToMount</span><span style="color:#E6E6E6;">, </span><span style="color:#9CDCFE;">appsToUnmount</span><span style="color:#E6E6E6;"> } </span><span style="color:#D4D4D4;">=</span><span style="color:#DCDCAA;"> getAppChanges</span><span style="color:#E6E6E6;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C586C0;">  if</span><span style="color:#E6E6E6;"> (</span><span style="color:#9CDCFE;">started</span><span style="color:#E6E6E6;">) {</span></span>
<span class="line"><span style="color:#C586C0;">    return</span><span style="color:#DCDCAA;"> performAppChange</span><span style="color:#E6E6E6;">();</span></span>
<span class="line"><span style="color:#E6E6E6;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">  function</span><span style="color:#DCDCAA;"> performAppChange</span><span style="color:#E6E6E6;">() {</span></span>
<span class="line"><span style="color:#6A9955;">    // 将不需要的应用进行卸载</span></span>
<span class="line"><span style="color:#569CD6;">    const</span><span style="color:#9CDCFE;"> unmountAllPromises</span><span style="color:#D4D4D4;"> =</span><span style="color:#4EC9B0;"> Promise</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">all</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">allToUnmount</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">map</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">app</span><span style="color:#569CD6;"> =&gt;</span><span style="color:#DCDCAA;"> toUnmountPromise</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">)));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">    // 挂载对应的应用, 有一种可能要被挂载的应用已经加载过了，也可能没有被加载过</span></span>
<span class="line"><span style="color:#6A9955;">    // case: 从一个未知路由来到 a 应用路由</span></span>
<span class="line"><span style="color:#6A9955;">    // case: a 路由走完 registerApplication 然后再走 start</span></span>
<span class="line"><span style="color:#569CD6;">    const</span><span style="color:#9CDCFE;"> mountAllPromises</span><span style="color:#D4D4D4;"> =</span><span style="color:#4EC9B0;"> Promise</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">all</span><span style="color:#E6E6E6;">(</span></span>
<span class="line"><span style="color:#9CDCFE;">      appToLoad</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">map</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">app</span><span style="color:#569CD6;"> =&gt;</span><span style="color:#DCDCAA;"> toLoadPromise</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">).</span><span style="color:#DCDCAA;">then</span><span style="color:#E6E6E6;">((</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">) </span><span style="color:#569CD6;">=&gt;</span><span style="color:#E6E6E6;"> {</span></span>
<span class="line"><span style="color:#6A9955;">        // 当应用加载完毕后，需要启动和挂载，但是保证挂载前先卸载应用。</span></span>
<span class="line"><span style="color:#C586C0;">        return</span><span style="color:#DCDCAA;"> tryBootstrapAndMount</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">, </span><span style="color:#9CDCFE;">unmountAllPromises</span><span style="color:#E6E6E6;">);</span></span>
<span class="line"><span style="color:#E6E6E6;">      }))</span></span>
<span class="line"><span style="color:#E6E6E6;">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">    function</span><span style="color:#DCDCAA;"> tryBootstrapAndMount</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">, </span><span style="color:#9CDCFE;">unmountAllPromises</span><span style="color:#E6E6E6;">) {</span></span>
<span class="line"><span style="color:#6A9955;">      // 确保当前路径匹配完成后，再进行启动</span></span>
<span class="line"><span style="color:#C586C0;">      if</span><span style="color:#E6E6E6;"> (</span><span style="color:#DCDCAA;">shouldBeActive</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">)) {</span></span>
<span class="line"><span style="color:#C586C0;">        return</span><span style="color:#DCDCAA;"> toBootstrapPromise</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">)</span></span>
<span class="line"><span style="color:#E6E6E6;">          .</span><span style="color:#DCDCAA;">then</span><span style="color:#E6E6E6;">((</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">) </span><span style="color:#569CD6;">=&gt;</span><span style="color:#E6E6E6;"> {</span></span>
<span class="line"><span style="color:#6A9955;">            // 确保全部卸载后，再进行挂载</span></span>
<span class="line"><span style="color:#C586C0;">            return</span><span style="color:#9CDCFE;"> unmountAllPromises</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">then</span><span style="color:#E6E6E6;">(() </span><span style="color:#569CD6;">=&gt;</span><span style="color:#DCDCAA;"> toMountPromise</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">));</span></span>
<span class="line"><span style="color:#E6E6E6;">          });</span></span>
<span class="line"><span style="color:#E6E6E6;">      }</span></span>
<span class="line"><span style="color:#E6E6E6;">    }</span></span>
<span class="line"><span style="color:#E6E6E6;">  }</span></span>
<span class="line"><span style="color:#6A9955;">  // ... ...</span></span>
<span class="line"><span style="color:#E6E6E6;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div></div></div><p><code>bootstrap</code>, <code>mount</code>, <code>unmount</code> 需要控制一下内部的状态流转，将 props 进行传递，并且调用。</p><div class="vp-code-group"><div class="tabs"><input type="radio" name="group-l1Hlc" id="tab-4NzTKkH" checked><label data-title="lifecycles/bootstrap.js" for="tab-4NzTKkH">lifecycles/bootstrap.js</label><input type="radio" name="group-l1Hlc" id="tab-nIi4v30"><label data-title="lifecycles/mount.js" for="tab-nIi4v30">lifecycles/mount.js</label><input type="radio" name="group-l1Hlc" id="tab-QDRT_Ml"><label data-title="lifecycles/unmount.js" for="tab-QDRT_Ml">lifecycles/unmount.js</label></div><div class="blocks"><div class="language-js active line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki slack-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#C586C0;">export</span><span style="color:#569CD6;"> function</span><span style="color:#DCDCAA;"> toBootstrapPromise</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">) {</span></span>
<span class="line"><span style="color:#C586C0;">  return</span><span style="color:#4EC9B0;"> Promise</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">resolve</span><span style="color:#E6E6E6;">().</span><span style="color:#DCDCAA;">then</span><span style="color:#E6E6E6;">(() </span><span style="color:#569CD6;">=&gt;</span><span style="color:#E6E6E6;"> {</span></span>
<span class="line"><span style="color:#C586C0;">    if</span><span style="color:#E6E6E6;"> (</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">.</span><span style="color:#9CDCFE;">status</span><span style="color:#D4D4D4;"> !==</span><span style="color:#9CDCFE;"> NOT_BOOTSTRAPED</span><span style="color:#E6E6E6;">) {</span></span>
<span class="line"><span style="color:#C586C0;">      return</span><span style="color:#9CDCFE;"> app</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#E6E6E6;">    }</span></span>
<span class="line"><span style="color:#9CDCFE;">    app</span><span style="color:#E6E6E6;">.</span><span style="color:#9CDCFE;">status</span><span style="color:#D4D4D4;"> =</span><span style="color:#9CDCFE;"> BOOTSTRAPING</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#6A9955;">    // 执行用户的接入协议</span></span>
<span class="line"><span style="color:#C586C0;">    return</span><span style="color:#9CDCFE;"> app</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">bootstrap</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">.</span><span style="color:#9CDCFE;">customProps</span><span style="color:#E6E6E6;">).</span><span style="color:#DCDCAA;">then</span><span style="color:#E6E6E6;">(() </span><span style="color:#569CD6;">=&gt;</span><span style="color:#E6E6E6;"> {</span></span>
<span class="line"><span style="color:#9CDCFE;">      app</span><span style="color:#E6E6E6;">.</span><span style="color:#9CDCFE;">status</span><span style="color:#D4D4D4;"> =</span><span style="color:#9CDCFE;"> NOT_MOUNT</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#C586C0;">      return</span><span style="color:#9CDCFE;"> app</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#E6E6E6;">    });</span></span>
<span class="line"><span style="color:#E6E6E6;">  });</span></span>
<span class="line"><span style="color:#E6E6E6;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki slack-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#C586C0;">export</span><span style="color:#569CD6;"> function</span><span style="color:#DCDCAA;"> toMountPromise</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">) {</span></span>
<span class="line"><span style="color:#C586C0;">  return</span><span style="color:#4EC9B0;"> Promise</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">resolve</span><span style="color:#E6E6E6;">().</span><span style="color:#DCDCAA;">then</span><span style="color:#E6E6E6;">(() </span><span style="color:#569CD6;">=&gt;</span><span style="color:#E6E6E6;"> {</span></span>
<span class="line"><span style="color:#C586C0;">    if</span><span style="color:#E6E6E6;"> (</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">.</span><span style="color:#9CDCFE;">status</span><span style="color:#D4D4D4;"> !==</span><span style="color:#9CDCFE;"> NOT_MOUNT</span><span style="color:#E6E6E6;">) {</span></span>
<span class="line"><span style="color:#C586C0;">      return</span><span style="color:#9CDCFE;"> app</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#E6E6E6;">    }</span></span>
<span class="line"><span style="color:#9CDCFE;">    app</span><span style="color:#E6E6E6;">.</span><span style="color:#9CDCFE;">status</span><span style="color:#D4D4D4;"> =</span><span style="color:#9CDCFE;"> MOUNTING</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#6A9955;">    // 执行用户的接入协议</span></span>
<span class="line"><span style="color:#C586C0;">    return</span><span style="color:#9CDCFE;"> app</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">mount</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">.</span><span style="color:#9CDCFE;">customProps</span><span style="color:#E6E6E6;">).</span><span style="color:#DCDCAA;">then</span><span style="color:#E6E6E6;">(() </span><span style="color:#569CD6;">=&gt;</span><span style="color:#E6E6E6;"> {</span></span>
<span class="line"><span style="color:#9CDCFE;">      app</span><span style="color:#E6E6E6;">.</span><span style="color:#9CDCFE;">status</span><span style="color:#D4D4D4;"> =</span><span style="color:#9CDCFE;"> MOUNTED</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#C586C0;">      return</span><span style="color:#9CDCFE;"> app</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#E6E6E6;">    });</span></span>
<span class="line"><span style="color:#E6E6E6;">  });</span></span>
<span class="line"><span style="color:#E6E6E6;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki slack-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#C586C0;">export</span><span style="color:#569CD6;"> function</span><span style="color:#DCDCAA;"> toUnmountPromise</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">) {</span></span>
<span class="line"><span style="color:#C586C0;">  return</span><span style="color:#4EC9B0;"> Promise</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">resolve</span><span style="color:#E6E6E6;">().</span><span style="color:#DCDCAA;">then</span><span style="color:#E6E6E6;">(() </span><span style="color:#569CD6;">=&gt;</span><span style="color:#E6E6E6;"> {</span></span>
<span class="line"><span style="color:#C586C0;">    if</span><span style="color:#E6E6E6;"> (</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">.</span><span style="color:#9CDCFE;">status</span><span style="color:#D4D4D4;"> !==</span><span style="color:#9CDCFE;"> MOUNTED</span><span style="color:#E6E6E6;">) {</span></span>
<span class="line"><span style="color:#C586C0;">      return</span><span style="color:#9CDCFE;"> app</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#E6E6E6;">    }</span></span>
<span class="line"><span style="color:#9CDCFE;">    app</span><span style="color:#E6E6E6;">.</span><span style="color:#9CDCFE;">status</span><span style="color:#D4D4D4;"> =</span><span style="color:#9CDCFE;"> UNMOUNTING</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#6A9955;">    // 执行用户的接入协议</span></span>
<span class="line"><span style="color:#C586C0;">    return</span><span style="color:#9CDCFE;"> app</span><span style="color:#E6E6E6;">.</span><span style="color:#DCDCAA;">unmount</span><span style="color:#E6E6E6;">(</span><span style="color:#9CDCFE;">app</span><span style="color:#E6E6E6;">.</span><span style="color:#9CDCFE;">customProps</span><span style="color:#E6E6E6;">).</span><span style="color:#DCDCAA;">then</span><span style="color:#E6E6E6;">(() </span><span style="color:#569CD6;">=&gt;</span><span style="color:#E6E6E6;"> {</span></span>
<span class="line"><span style="color:#9CDCFE;">      app</span><span style="color:#E6E6E6;">.</span><span style="color:#9CDCFE;">status</span><span style="color:#D4D4D4;"> =</span><span style="color:#9CDCFE;"> NOT_MOUNT</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#C586C0;">      return</span><span style="color:#9CDCFE;"> app</span><span style="color:#E6E6E6;">;</span></span>
<span class="line"><span style="color:#E6E6E6;">    });</span></span>
<span class="line"><span style="color:#E6E6E6;">  });</span></span>
<span class="line"><span style="color:#E6E6E6;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></div></div><div class="note custom-block github-alert"><p class="custom-block-title">NOTE</p><p>总结：</p><ol><li><p>调用 <code>registerApplication</code> 给每个应用增加初始状态 <code>NOT_LOADED</code> <strong>未加载</strong>，并且第一次调用 <code>reroute</code>；</p></li><li><p>每次调用 <code>reroute</code> 都会根据应用的状态进行分类 <code>getAppChanges</code>。</p></li><li><p>第一次通过 <code>loadApps</code> 去加载应用，状态为<strong>正在加载</strong> <code>LOADING_SOURCE_CODE</code>，调用用户的 <code>loadApp</code> 后状态为<strong>没有启动</strong> <code>NOT_BOOTSTRAPED</code>；在这个过程中会处理用户的传入的声明周期方法（数组和单个函数）；</p></li><li><p>执行 <code>start</code> 方法将 <code>started</code> 置为 <code>true</code>，再次调用 <code>reroute</code>；</p></li><li><p>第二次根据分类好的数据先将所有已经 <code>MOUNTED</code> 的应用进行卸载（如果状态是<strong>挂载成功</strong> <code>MOUNTED</code>，就修改为<strong>卸载中</strong> <code>UNMOUNTING</code> 和<strong>未加载</strong> <code>NOT_LOADED</code>）。然后进入启动挂载流程；</p></li><li><p>考虑到用户有可能之前并没有走启动流程（因为是路由匹配，可能是未知路由到 a 子应用）所以还是要加载 <code>toLoadPromise</code>；</p></li><li><p><code>tryBootstrapAndMount</code> 走启动和挂载流程。<code>toBootstrapPromise</code> 启动时会将应用的状态修改为<strong>启动中</strong><code>BOOTSTRAPING</code> 和<strong>没有挂载</strong> <code>NOT_MOUNT</code>；</p></li><li><p><code>toMountPromise</code> 挂载之前会先确保已经全部卸载（unmount then 以后）将状态修改为<strong>挂载中</strong><code>MOUNTING</code> 和<strong>挂载成功</strong> <code>MOUNTED</code>；</p></li></ol></div>`,46)]))}const b=n(e,[["render",r]]);export{D as __pageData,b as default};
