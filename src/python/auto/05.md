---
outline: deep
---

## api 整合

## 日志管理

`pytest` 默认捕获 `WARNING` 级别的日志并且会记录模块、行号、日志级别和消息

```py
import logging

log = logging.getLogger(__name__)

def get_api_data():
    log.warning("get api data warning...")
    return "api data"

def test_case_01():
    assert get_api_data() == "api dataxx"
```

当用例执行错误时，会显示如下信息。

```
src/tests/test_case_01.py:11: AssertionError
---------------------------------------------------------- Captured log call -----------------------------------------------------------
注意：信息在这里
WARNING  test_case_01:test_case_01.py:7 get api data warning...
======================================================= short test summary info ========================================================
FAILED src/tests/test_case_01.py::test_case_01 - AssertionError: assert 'api data' == 'api dataxx'
========================================================== 1 failed in 0.03s ===========================================================
```

在执行的时候，可以指定输出时间格式。**当然这些也可以通过配置文件进行配置**

```bash
pytest --log-format="%(asctime)s %(levelname)s %(message)s" \
        --log-date-format="%Y-%m-%d %H:%M:%S"
```

```
src/tests/test_case_01.py:11: AssertionError
---------------------------------------------------------- Captured log call -----------------------------------------------------------
注意：增加了时间的显示
2025-09-15 22:20:37 WARNING get api data warning...
======================================================= short test summary info ========================================================
FAILED src/tests/test_case_01.py::test_case_01 - AssertionError: assert 'api data' == 'api dataxx'
========================================================== 1 failed in 0.03s ===========================================================
```

也可以通过 `--show-capture=no` 来关闭日志的输出。也可以通过 `--log-disable=` 指定测试用例名字禁止输出日志。

在 `pytest` 中提供了一个全局的 `fixture` 名为 `caplog` 它可以获取日志的信息，也可以临时的修改捕获日志的级别。

```py
import logging

def get_api_data():
    log.debug('get api data debug...')
    log.warning("get api data warning...")
    log.error("get api data error...")
    return "api data"

# 此时执行的时候就可以捕获到三条日志
def test_case_01(caplog):
    caplog.set_level(logging.DEBUG)
```

可以根据日志的返回信息进行断言。虽然我也不知道怎么用，或许是记录到文件之后才能打印出来吧。

```py
def test_case_01(caplog):
    # * caplog.messages        -> 日志消息列表
    # * caplog.text            -> 日志文本信息
    # * caplog.records         -> logging.LogRecord 格式的日志列表
    # * caplog.record_tuples   -> 包含 log level name 和 message 的元组列表
    # * caplog.clear()         -> 清空日志
```

最后通过 `--log-file=xx.log` 配置日志的生成，但是每次执行用例都会复写之前的 `log` 文件；此配置同样可以在配置文件中完成。

- 通过 `--log-file-mode=a` 来追加日志。
- 通过 `--log-file-level=INFO` 来指定日志级别。
- 通过 `--log-date-format=%Y-%m-%d %H:%M:%S` 指定输出的时间格式。与 `--log-file-date-format` 一样的效果
- 通过 `--log-format=%(asctime)s %(levelname)s %(message)s` 来指定输出的格式。与 `--log-file-format` 一样的效果

```bash
pytest --log-file=log/test.log --log-file-mode=a
```

## 配置文件

配置文件可以是 `pytest.ini`、`.pytest.ini` 或者是 `pyproject.toml` 其他的都不推荐。一般存储在项目的根目录中。

[参考文档](https://docs.pytest.org/en/stable/reference/customize.html#config-file-formats)

```ini
# pytest.ini or .pytest.ini
[pytest]
minversion = 6.0
addopts = -ra -q
testpaths =
    tests
    integration

# pyproject.toml
[tool.pytest.ini_options]
minversion = "6.0"
addopts = "-ra -q"
testpaths = [
    "tests",
    "integration",
]
```

### 日志配置

```ini
[pytest]
# 指定日志格式
log_format = %(asctime)s %(levelname)s %(message)s
# 配置日志时间格式
log_date_format = %Y-%m-%d %H:%M:%S
# 指定日志文件
log_file = ./log/test.log
# 追加写入模式
log_file_mode = a
# 记录 log 级别
log_file_level = DEBUG
# 多行日志缩进 True | On 、 False | Off
log_auto_indent=True # 缩进
```

### 测试发现规则配置

```ini
[pytest]
# 正则，结尾包含 Suite 的类作为测试集合。可以是多个，中间加空格
# 默认以 Test 开头的类作为测试集合。
python_classes = *Suite *Test

# 正则，指定哪些文件被视为测试模块。默认 `test_*.py` 和 `*_test.py`
# 可以是多个，也可以是换行
python_files = test_*.py check_*.py example_*.py
python_files =
    test_*.py
    check_*.py
    example_*.py

# 正则，执行哪些测试方法和函数被视为测试用例，可以是多个，中间加空格
# 默认以 test_ 开头的方法为测试用例。
python_functions = *_test

# 设置测试从哪个目录开始执行，默认是项目根目录
testpaths = testing_dir
```

### 其他常用配置项

```ini
[pytest]

```

## allure 测试报告生成

## 项目实战

### 自动化接口测试

### 自动化 WebUI 测试