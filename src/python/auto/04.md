---
outline: deep
---

`pytest` æ˜¯ä¸€ä¸ªä¸‰æ–¹çš„å•å…ƒæµ‹è¯•æ¡†æ¶ï¼Œæ¡†æ¶å¯ä»¥è½»æ¾ç¼–å†™å°å‹ã€å¯è¯»çš„æµ‹è¯•ï¼Œå¹¶ä¸”å¯ä»¥æ‰©å±•ä»¥æ”¯æŒåº”ç”¨ç¨‹åºå’Œåº“çš„å¤æ‚åŠŸèƒ½æµ‹è¯•ã€‚

```bash :no-line-numbers
pip install pytest
# uv
uv add pytest

# éªŒè¯ç‰ˆæœ¬ pytest 8.4.2
uv run pytest --version 
```

## å¿«é€Ÿå¼€å§‹

åœ¨ `pytest` ä¸­ä¸å†è¿½æ±‚å›ºå®šèŒƒå¼ï¼Œå¯ä»¥æ˜¯å‡½æ•°ã€ä¹Ÿå¯ä»¥æ˜¯ç±»ã€‚ä½†æ˜¯å¸Œæœ›ä½ çš„è¢«æµ‹è¯•æ–¹æ³•å‡½æ•°åä»¥ `test_` å¼€å¤´ã€‚å½“æµ‹è¯•ç”¨ä¾‹è¿‡å¤šæ—¶ï¼Œæˆ‘ä»ç„¶å»ºè®®ä½ ä½¿ç”¨ `class` å»ç»„ç»‡æµ‹è¯•ç”¨ä¾‹ã€‚

```py
def test_math_add():
    assert 1 + 2 == 3

def test_math_sub():
    assert 1 - 2 == -1

class TestString:
    def test_string_upper(self):
        assert "hello".upper() == "HELLO"

    def test_string_lower(self):
        assert "HELLO".lower() == "hello"
```

æ‰§è¡Œ `uv run pytest test_demo.py` ä¸Šè¿°å››ä¸ªç”¨ä¾‹ä¼šè¢«å…¨éƒ¨æ‰§è¡Œã€‚

## å‘½ä»¤è¡Œ

`pytest` çš„æµ‹è¯•å‘ç°è§„åˆ™æ˜¯ `test_*.py`ã€ `*_test.py`ã€‚åœ¨æ–‡ä»¶ä¸­ä¹Ÿä¼šå¯»æ‰¾åŒ…å« `test` çš„ç±»æˆ–è€…æ–¹æ³•ã€‚

| æè¿° | å‚æ•° |
| --- | --- | 
| æŒ‡å®šæµ‹è¯•ç”¨ä¾‹ï¼Œæ–‡æœ¬åŒ¹é…ï¼Œæ”¯æŒ `and or not` <br> æ‰§è¡Œä¸åŒ…å« math çš„æµ‹è¯•ç”¨ä¾‹ | `-k` |    
| å®‰é™æ¨¡å¼ | `-q \| --quiet` |    
| å…è®¸è¾“å‡º print ä¿¡æ¯ | `-s` |    
| è¿è¡Œæ›´è¯¦ç»†çš„æµ‹è¯•ç”¨ä¾‹ | `-v \| -vv \| -vvv` |     
| æœ€å¤šè¿è¡Œ n ä¸ªå¤±è´¥ç”¨ä¾‹ | `--maxfail=` |    
| æ’é™¤ä¸æ‰§è¡Œçš„ç›®å½•æˆ–æ–‡ä»¶ï¼Œ<br>å¯ä»¥ä½¿ç”¨å¤šä¸ª | `--ignore=` |    
| æ’é™¤ä¸æ‰§è¡Œçš„ç›®å½•æˆ–æ–‡ä»¶ | `--ignore-glob=` |    
| æŒ‡å®šæ ‡è®° | `-m` |    
| æŒ‡å®šæ–¹æ³•æˆ–è€…ç±» | `::` |    


```bash :no-line-numbers
# æ‰§è¡Œå•ä¸ªæ–‡ä»¶
pytest test_demo.py
# æ‰§è¡Œç›®å½•
pytest testing/

# -k æŒ‡å®šæµ‹è¯•ç”¨ä¾‹
# ä¸åŒ…å« math çš„æµ‹è¯•éƒ½è¦è¢«æ‰§è¡Œã€‚
# å¯ä»¥è¢«ä½¿ç”¨çš„å…³é”®å­— and not or
pytest -k "not math" testing/

# -q å®‰é™æ¨¡å¼ æˆ– --quiet
# -v è¿è¡Œæ›´è¯¦ç»†çš„æµ‹è¯•ç”¨ä¾‹ã€‚æ§åˆ¶å°è¾“å‡ºæ›´å¤šçš„ä¿¡æ¯
# -vv æ›´è¯¦ç»†çš„æµ‹è¯•ç”¨ä¾‹
# -vvv ä¸æ˜¯æ ‡å‡†ï¼Œä½†å¯ç”¨äºæŸäº›è®¾ç½®ä¸­çš„æ›´å¤šç»†èŠ‚
pytest -v testing/

# -s å…è®¸è¾“å‡º print ä¿¡æ¯
pytest -s testing/

# --maxfail= æœ€å¤šè¿è¡Œ 2 ä¸ªå¤±è´¥ç”¨ä¾‹
pytest --maxfail=2 testing/

# --ignore æ’é™¤ä¸æ‰§è¡Œçš„ç›®å½•æˆ–æ–‡ä»¶
pytest --ignore=testing/test_demo.py testing/
# å¯ä»¥æŒ‡å®šå¤šä¸ª
pytest --ignore=testing/test_demo.py --ignore=testing/test_string.py testing/

# --ignore-glob æ’é™¤ä¸æ‰§è¡Œçš„ç›®å½•æˆ–æ–‡ä»¶ æ­£åˆ™æ–¹å¼
pytest --ignore-glob='*.py' testing/

# -m
# è¿è¡Œæ‰€æœ‰ @pytest.mark.slow æ ‡è®°çš„æµ‹è¯•ç”¨ä¾‹
# ä¹Ÿå¯ä»¥æ˜¯è¿™æ · "slow(phase=1)"
pytest -m show

# ä¹Ÿå¯ä»¥é€šè¿‡ :: æŒ‡å®šæ–¹æ³•æˆ–è€…ç±»çš„è¿è¡Œ
# 1. æŒ‡å®šç±»ä¸‹çš„æŒ‡å®šæ–¹æ³•
pytest test_demo.py::TestString::test_string_upper
# 2. æŒ‡å®šç±»
pytest test_demo.py::TestString
# 3. ä¸ºæ–¹æ³•ä¼ é€’å‚æ•°
pytest test_demo.py::test_math_add[1, 2]
```

**éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“æŒ‡å®šæ–¹æ³•çš„æ—¶å€™å®ƒå°±åªæ˜¯ä¸€ä¸ªæ–‡ä»¶ä¸­çš„æ–¹æ³•(`pytest test_demo.py::test_math_add`)ï¼Œä¸ç„¶ä½ åº”è¯¥åšçš„æ˜¯æŒ‡å®šç±»ä¸‹é¢çš„æ–¹æ³• `pytest test_demo.py::TestString::test_string_upper`**


## TestFixture

è¿™åº”è¯¥æ˜¯ `pytest` å‡ºåœˆçš„ä¸»è¦åŠŸèƒ½äº†ï¼Œæä¾›çš„å¤ç”¨èƒ½åŠ›æ¯”è¾ƒä¸ `unittest` å¼ºå¤§äº†å¾ˆå¤šã€‚å¼ºçš„å¤´çš®å‘éº»....

### å¿«é€Ÿå¼€å§‹

ä»ç¤ºä¾‹ä¸­çœ‹ï¼Œ**è¢« `@pytest-fixture` è£…é¥°å™¨æ‰€åŒ…è£¹çš„æ–¹æ³•éƒ½ä¼šè¢«æ‰§è¡Œå¹¶ä¸”è¢«æµ‹è¯•å‡½æ•°æ‰€ä½¿ç”¨ã€‚æ­¤å¤–ä»–ä»¬è‡ªèº«è¿˜å¯ä»¥è¢«å…¶ä»– `fixture` æ‰€ä½¿ç”¨ã€‚**

å¯èƒ½æœ‰ç‚¹ç»•ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œä»¥æµ‹è¯•åŠ æ³•è¿ç®—ä¸ºä¾‹ã€‚å¯æ˜¯æŠŠé¢„æœŸå’Œå‚æ•°éƒ½ä½œä¸º `fixture` ä¼ å…¥ã€‚

```py
@pytest.fixture
def add_params():
    return 1, 2

@pytest.fixture
def add_result():
    return 3

# pytest.fixture ä¼šæ‰§è¡Œè¢«è£…é¥°çš„æ–¹æ³•å¹¶ä¸”æ‹¿åˆ°è¿”å›å€¼
def test_add(add_params, add_result):
    assert sum(add_params) == add_result
```

å†æˆ–è€…ç”šè‡³å¯ä»¥å°†è¿ç®—çš„è¿‡ç¨‹æ”¾åœ¨ `add_result` ä¸­ã€‚ä»¥è¾¾åˆ° `fixture` ä¹‹é—´å¼•ç”¨çš„ç›®çš„ã€‚å½“ç„¶æˆ‘åªæ˜¯æƒ³ä¸ºä½ æ¼”ç¤ºä»–ä»¬ä¹‹é—´æ‰§è¡Œçš„è¿‡ç¨‹ï¼Œæ²¡æœ‰åˆ«çš„æ„æ€ã€‚

```py
@pytest.fixture
def add_params():
    return 1, 2

# æ¥æ”¶ add_params è¿™ä¸ª fixture
@pytest.fixture
def get_add_result_is_successed(add_params):
    return sum(add_params) == 3

def test_add(get_add_result_is_successed):
    assert get_add_result_is_successed
```

å®é™…ä¸Šè¿™éƒ½æ˜¯ `pytest` ä¸ºä½ åšçš„äº‹æƒ…ï¼Œå¦‚æœæ˜¯è‡ªå·±æ‰§è¡Œï¼Œåˆ™éœ€è¦ä»¥ä¸‹æ–¹æ¡ˆ

```py
def add_params():
    return 1, 2

def get_add_result_is_successed(add_params):
    return sum(add_params) == 3

def test_add(get_add_result_is_successed):
    assert get_add_result_is_successed

if __name__ == "__main__":
    add_params = add_params() # æ‰§è¡Œ add_params
    get_add_result_is_successed(add_params) # æ‰§è¡Œ get_add_result_is_successed
    test_add(get_add_result_is_successed) # æ‰§è¡Œ test_add
```

### Fixture ä¸­çš„æ•°æ®å¤ç”¨

è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„ç‚¹ `fixture` å’Œç”¨ä¾‹ä¹‹é—´çš„æ•°æ®æ˜¯èƒ½å¤Ÿè¢«å¤ç”¨ã€‚æœ€å¥½ä¸è¦æœ‰é€šè¿‡ç”¨ä¾‹å»æ”¹å˜ä»–è¿”å›å€¼çš„æƒ³æ³•ã€‚

```py
@pytest.fixture
def add_params():
    return [1, 2]

def test_add_params(add_params):
    add_params.append(3)
    assert add_params == [1, 2, 3]

def test_add(add_params):
    assert add_params == [1, 2]
```

åœ¨å¤šä¸ª `fixture` å†…éƒ¨æ•°æ®çš„æ•°æ®å¯ä»¥è¢«å¤ç”¨ï¼Œå¹¶ä¸”ä¼šè¢«æœ€ç»ˆè¿”å›ã€‚**ç”¨ä¾‹ä¸­åˆ™ä¼šæ‹¿åˆ°æœ€ç»ˆæ•°æ®ï¼Œè¿™ä¸€åˆ‡çš„å‰ææ˜¯ä½ ä½¿ç”¨äº†æ›´æ”¹é‚£ä¸ªæ•°æ®çš„ `fixture`ã€‚è¿™ä¸€åˆ‡è¿˜æ˜¯ä¸»è¦å½’åŠŸäº `@pytest.fixture` çš„è‡ªåŠ¨æ‰§è¡Œå‡½æ•°çš„ç‰¹æ€§ã€‚**

```py
@pytest.fixture
def list_data():
    return [1, 2]

@pytest.fixture
def append_list_data(list_data):
    list_data.append(3)
    return list_data

# Error
def test_01_add_params(list_data):
    assert list_data == [1, 2, 3]
# Success
def test_02_add_params(append_list_data, list_data):
    assert list_data == [1, 2, 3]
```

### è‡ªåŠ¨ä½¿ç”¨ autouse

å½“ä¸º `@pytest.fixture` å¢åŠ æ­¤å‚æ•°åï¼Œæ— è®ºæ˜¯å¦ä½¿ç”¨äº†è¯¥ `fixture` ä»–éƒ½ä¼šè¢«æ‰§è¡Œã€‚

```py
@pytest.fixture
def mock_test_data():
    return 'test data'

@pytest.fixture
def mock_test_container():
    return []

# æ— è®ºæœ‰æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œéƒ½ä¼šè¢«æ‰§è¡Œ
# å…¶èƒŒéƒ¨å·²ç»æ›´æ”¹äº† mock_test_container çš„è¿”å›å€¼
@pytest.fixture(autouse=True)
def mock_autouse(mock_test_data, mock_test_container):
    return mock_test_container.append(mock_test_data)

# Successed
def test_01(mock_test_container):
    assert mock_test_container == ['test data']
```

### Fixture çš„ä½œç”¨åŸŸ

è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„åŠŸèƒ½ï¼Œå°±åƒåœ¨ `unittest` ä¸­çš„ `setUp` ä¸€æ ·ã€‚ç†è®ºä¸Šæ¥è¯´ä½œç”¨åŸŸè¶Šå¤§ï¼Œå¤ç”¨æ€§è¶Šé«˜ã€‚ä½†æ˜¯ä¹Ÿè¦ç»“åˆå®é™…æƒ…å†µã€‚

åŒæ ·çš„ï¼Œä½ éœ€è¦å‘ `@pytest.fixture` ä¼ é€’å‚æ•°ï¼Œåä¸º `scope`ã€‚ å–å€¼åŒ…å« `function`ã€`class`ã€`module`ã€`package`ã€`session`ã€‚é»˜è®¤å€¼ä¸º `function`ã€‚

- `function`ï¼šé»˜è®¤èŒƒå›´ï¼Œåœ¨æµ‹è¯•ç»“æŸæ—¶è¢«é”€æ¯ã€‚
- `class`ï¼šåœ¨æ‹†å¸ç±»ä¸­çš„æœ€åä¸€ä¸ªæµ‹è¯•æ—¶ï¼Œè¢«é”€æ¯ã€‚
- `module`ï¼šåœ¨æ‹†å¸æ¨¡å—ä¸­çš„æœ€åä¸€ä¸ªæµ‹è¯•æ—¶ï¼Œè¢«é”€æ¯ã€‚
- `package`ï¼šåœ¨æ‹†å¸åŒ…ä¸­çš„æœ€åä¸€ä¸ªæµ‹è¯•æ—¶ï¼ŒåŒ…æ‹¬å…¶ä¸­çš„å­åŒ…å’Œå­ç›®å½•ã€‚è¢«é”€æ¯ã€‚
- `session`ï¼šåœ¨æ•´ä¸ªæµ‹è¯•ä¼šè¯ç»“æŸæ—¶ï¼Œè¢«é”€æ¯ã€‚

å®é™…ä¸Šè¿™äº›ä½œç”¨åŸŸçš„å¤§å°ï¼Œæ˜¯æ ¹æ®ä½ é¡¹ç›®ä¸­æ–‡ä»¶çš„ç»„ç»‡ç»“æ„æ¥å®šçš„ã€‚

#### function

`function` ä½œç”¨åŸŸï¼Œ**æ¯ä¸ªå‡½æ•°éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡**

```py
@pytest.fixture
def mock_test_data():
    print('function scope staring....')

def test_01(mock_test_data):
    print('function test ... ğŸš€')

def test_02(mock_test_data):
    print('function test ... ğŸš€')

# function scope staring....
# function test ... ğŸš€
# function scope staring....
# function test ... ğŸš€
```

#### class

`class` ä½œç”¨åŸŸï¼Œ**åœ¨ç±»ä¸­åªä¼šè°ƒç”¨ä¸€æ¬¡**

```py
@pytest.fixture(scope='class')
def mock_test_dict():
    print('class scope starting...')

class TestDict:
    def test_dict_01(self, mock_test_dict):
        print('class test ... ğŸš€')

    def test_dict_02(self, mock_test_dict):
        print('class test ... ğŸš€')

# class scope starting...
# class test ... ğŸš€
# class test ... ğŸš€
```

#### module

`module` ä½œç”¨åŸŸï¼Œ**åœ¨æ¨¡å—(ä¸€ä¸ªæ–‡ä»¶)ä¸­ä¼šè°ƒç”¨ä¸€æ¬¡ï¼Œæ— è®ºæœ‰å¤šå°‘ä¸ªæµ‹è¯•ç”¨ä¾‹æˆ–è€…ç±»å’Œæ–¹æ³•**

```py
@pytest.fixture(scope='module')
def mock_test_dict():
    print('module scope starting...')

def test_dict_01(mock_test_dict):
    print('module test ... ğŸš€')

def test_dict_02(mock_test_dict):
    print('module test ... ğŸš€')

# module scope starting...
# module test ... ğŸš€
# module test ... ğŸš€
```

#### package 

`package` ä½œç”¨åŸŸï¼Œ**åœ¨åŒ…(ä¸€ä¸ªç›®å½•ï¼Œå¯ä»¥åµŒå¥—)ä¸­ä¼šè°ƒç”¨ä¸€æ¬¡ï¼Œæ— è®ºæœ‰å¤šå°‘ä¸ªæµ‹è¯•ç”¨ä¾‹æˆ–è€…ç±»å’Œæ–¹æ³•ã€‚å®é™…ä¸Šä½ ä¸å­˜åœ¨ `__init__.py` ä¹Ÿä¼šè¢«å½“åšåŒ…ã€‚**

```py
@pytest.fixture(scope='package')
def mock_test_dict():
    print('package scope starting...')

# package scope starting...
```

#### session 

`session` ä½œç”¨åŸŸï¼Œ**åœ¨æ•´ä¸ªæµ‹è¯•ä¼šè¯ç»“æŸæ—¶ï¼Œè¢«é”€æ¯ã€‚** ä»ä½œç”¨çš„èŒƒå›´æ¥çœ‹åœ¨é¡¹ç›®ä¸­ `package` å’Œ `session` çš„ä½¿ç”¨æ²¡æœ‰å¤ªå¤§åŒºåˆ«ã€‚

```py
@pytest.fixture(scope='session')
def mock_test_dict():
    print('session scope starting...')

# session scope starting...
```

#### æ‰§è¡Œé¡ºåºä¸é€»è¾‘æŠ½ç¦»

æ‰§è¡Œé¡ºåºä¸Šæ¥çœ‹ï¼Œ`session -> package -> module -> class -> function`ã€‚

```py
@pytest.fixture(scope='session')
def session_fixture():
    print('session scope starting...')

@pytest.fixture(scope='package')
def package_fixture():
    print('package scope starting...')

@pytest.fixture(scope='module')
def module_fixture():
    print('module scope starting...')

@pytest.fixture(scope='class')
def class_fixture():
    print('class scope starting...')

@pytest.fixture(scope='function')
def function_fixture():
    print('function scope starting...')

class TestClass:
    def test_method_01(self, session_fixture, package_fixture, module_fixture, class_fixture, function_fixture):
        print('test_method_01')

# session scope starting...
# package scope starting...
# module scope starting...
# class scope starting...
# function scope starting...
# test_method_01
```

å¦‚æœä½ æƒ³å°†è¿™ä¸ª `fixture` æŠ½ç¦»åˆ°å•ç‹¬çš„æ–‡ä»¶å»ç®¡ç†ï¼Œå¯ä»¥ä½¿ç”¨ `conftest.py`ã€‚è¿™æ˜¯ä¸€ä¸ªçº¦å®šçš„æ–‡ä»¶åã€‚åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­å®šä¹‰çš„ `fixture` ä¼šè¢«è‡ªåŠ¨å¯¼å…¥åˆ°æ‰€æœ‰æµ‹è¯•æ–‡ä»¶ä¸­ã€‚æ— éœ€æ‰‹åŠ¨ `import`ã€‚

åœ¨å®é™…çš„é¡¹ç›®ä¸­ `conftest.py` é€šå¸¸ä¼šæ”¾åœ¨æµ‹è¯•æ–‡ä»¶çš„æ ¹ç›®å½•ä¸‹ã€‚å½“ç„¶ä»–ä¸æ­¢ä¸€ä¸ªï¼Œå¦‚æœé¡¹ç›®æ¯”è¾ƒå¤æ‚ï¼Œä»–å¯èƒ½å­˜åœ¨äºå¤šä¸ªå­ç›®å½•ä¸‹ã€‚

```
project/
â”œâ”€â”€ conftest.py                    # å…¨å±€fixtureï¼šæ•°æ®åº“ã€é…ç½®ç­‰
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ conftest.py               # æµ‹è¯•æ ¹ç›®å½•çš„å…±äº«fixture
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ conftest.py           # APIæµ‹è¯•ä¸“ç”¨fixture
â”‚   â”‚   â”œâ”€â”€ test_users.py
â”‚   â”‚   â””â”€â”€ test_products.py
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ conftest.py           # æ¨¡å‹æµ‹è¯•ä¸“ç”¨fixture
â”‚   â”‚   â”œâ”€â”€ test_user_model.py
â”‚   â”‚   â””â”€â”€ test_product_model.py
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ conftest.py           # å·¥å…·å‡½æ•°æµ‹è¯•ä¸“ç”¨fixture
â”‚       â””â”€â”€ test_helpers.py
â””â”€â”€ src/
```

### Fixture çš„å¸è½½ä¸æ¸…ç†

åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ï¼Œä¸€ç›´åœ¨è¾“å‡ºä¸€ä¸ªç†å¿µã€‚`fixture return` å‡ºæ¥çš„å†…å®¹ä¼šè¢«æµ‹è¯•ç”¨ä¾‹æ‰€æ¥æ”¶ã€‚å®é™…ä¸Šä¹Ÿå¯ä»¥æŠŠ `return` æ›¿æ¢æˆ `yield`ã€‚

è¿™æ ·åœ¨ `yield` åé¢å¯ä»¥åšä¸€äº›æ¸…ç†çš„æ“ä½œã€‚

æ¯”å¦‚æˆ‘ä»¬è¦è¿æ¥ä¸€ä¸ªæ•°æ®åº“ï¼Œé‚£æ“ä½œä¹‹ååº”è¯¥åŠæ—¶çš„å»æ–­å¼€å®ƒ

```py
import pytest
# å‡è®¾åœ¨é¡¹ç›®ä¸­æœ‰ä¸€ä¸ªåˆ›å»ºç”¨æˆ·çš„æ¥å£
class User:
    def __init__(self):
        self.users = []

    def create_user(self, user):
        self.users.append(user)
        return self.users[-1]

@pytest.fixture(scope='class')
def user_fixture():
    # è¿™ä¸ª fixture ç±»ä¸­çš„ç”¨ä¾‹æ‰§è¡Œä¹‹å‰çš„å‰ç½®æ“ä½œ
    user = User()
    yield user
    # è¿™ä¸ª fixture ç±»ä¸­çš„ç”¨ä¾‹æ‰§è¡Œä¹‹åçš„åç½®æ“ä½œ
    user.users = []

class TestUser:
    def test_create_user_01(self, user_fixture):
        user = user_fixture.create_user({"id": 1, "name": "test"})
        assert user["id"] == 1

    def test_create_user_02(self, user_fixture):
        user = user_fixture.create_user({"id": 2, "name": "test2"})
        assert user["id"] == 2
```

å½“ç„¶ï¼Œå¦‚æœåœ¨ç”¨ä¾‹çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå‡ºç°äº†å¼‚å¸¸ï¼Œé‚£ä¹ˆ `yield` ä¹‹åçš„å†…å®¹å°±ä¸ä¼šè¢«æ‰§è¡Œã€‚

### å°†æµ‹è¯•æ•°æ®ä¼ é€’ç»™ Fixture

é€šè¿‡ç»™æµ‹è¯•ç”¨ä¾‹å¢åŠ  `@pytest.mark.fixt_data()` ä¼ é€’å‚æ•°ã€‚

`fixture` åˆ™æ˜¯é€šè¿‡ `request` è¿›è¡Œè·å–ã€‚`request.node.get_closest_marker("fixt_data")`

ç›®å‰æˆ‘ä¸èƒ½ç†è§£ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšã€‚

```py
@pytest.fixture
def fixt(request):
    return request.node.get_closest_marker("fixt_data").args[0]

@pytest.mark.fixt_data("test data")
def test_01(fixt):
    assert fixt == "test data"
```

### å‚æ•°åŒ–çš„ Fixture

å‚æ•°åŒ–æ˜¯ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œå®ƒå¯ä»¥è®©ä½ è¿è¡Œä¸€ç»„æµ‹è¯•ï¼Œå¹¶ä¸”ä½¿ç”¨ä¸åŒçš„æ•°æ®ã€‚

```py
import pytest

@pytest.fixture(params=[1, 2, 3])
def data_set(request):
    return request.param

def test_data(data_set):
    print(data_set)

# src/tests/test_case2.py::test_data[1] 1
# src/tests/test_case2.py::test_data[2] 2
# src/tests/test_case2.py::test_data[3] 3
```

### å¤å†™å„ä¸ªçº§åˆ«çš„ Fixture

å¯ä»¥åœ¨å­æ–‡ä»¶å¤¹ä¸­å¤å†™å¤–å±‚çš„ `fixture`ã€‚è¯´ç™½äº†åªè¦ä½ åœ¨å­æ–‡ä»¶å¤¹çš„ `confset.py` å£°æ˜é‡åçš„ `fixture`ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™å°±ä¼šä»¥å°±è¿‘åŸåˆ™ä½¿ç”¨ã€‚è¾¾åˆ°å¤å†™çš„ç›®çš„ã€‚

å‡è®¾æ–‡ä»¶ç»“æ„å¦‚ä¸‹

```
project/
â”œâ”€â”€ conftest.py
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ conftest.py
â”‚   â””â”€â”€ test_case1.py
â”‚   â””â”€â”€ sub_tests/
â”‚       â””â”€â”€ conftest.py
â”‚       â””â”€â”€ sub_test_case1.py
```

::: code-group

```py [tests/conftest.py]
import pytest

# æ™®é€šçš„ fixture
@pytest.fixture
def plain_fixture():
    return 'plain fixture'

# å‚æ•°åŒ–çš„ fixture
@pytest.fixture(params=[1, 2, 3])
def params_fixture(request):
    return request.param
```

```py [tests/test_case1.py]
def test_plain_fixture(plain_fixture):
    assert plain_fixture == 'plain fixture'

def test_params_fixture(params_fixture):
    assert params_fixture in [1, 2, 3]
```

```py [sub_tests/conftest.py]
import pytest

# åœ¨ sub ä¸­å°† plain_fixture æ”¹ä¸ºå‚æ•°åŒ–çš„ fixture
@pytest.fixture(params=['plain changed params'])
def plain_fixture(request):
    return request.param

# åœ¨ sub ä¸­å°† params_fixture æ”¹ä¸ºæ™®é€š fixture
@pytest.fixture()
def params_fixture():
    return 'params changed plain'
```

```py [sub_tests/sub_test_case1.py]
def sub_test_plain_fixture(plain_fixture):
    assert plain_fixture in ['plain changed params']

def sub_test_params_fixture(params_fixture):
    assert params_fixture == 'params changed plain'

```
:::

## æµ‹è¯•ç”¨ä¾‹å‚æ•°åŒ–

ä½¿ç”¨ `@pytest.mark.parametrize` å¯ä»¥å®ç°æµ‹è¯•ç”¨ä¾‹çš„å‚æ•°åŒ–ã€‚æ¥æ”¶ä¸¤ä¸ªå‚æ•°

- è¾“å…¥å’Œé¢„æœŸç»“æœçš„å­—æ®µ
- è¾“å…¥å’Œé¢„æœŸç»“æœçš„å€¼å’Œè¡¨è¾¾å¼ï¼Œæ•°ç»„å¥—å…ƒç»„çš„æ¨¡å¼

```py
import pytest

@pytest.mark.parametrize('test_input, expected', [('1+2', 3), ('1+3', 4)])
def test_params_data(test_input, expected):
    assert eval(test_input) == expected
```

å¦‚æœä½¿ç”¨ç±»çš„æ¨¡å¼åˆ™å¯ä»¥ä¸ºç”¨ä¾‹æŒ‡å®šæ›´å¤šçš„æµ‹è¯•æ¨¡å¼ï¼Œç±»ä¸­çš„æ¯ä¸ªç”¨ä¾‹éƒ½ä¼šè¢«å‚æ•°åŒ–

```py
import pytest

@pytest.mark.parametrize('test_input, expected', [(2, 3), (4, 5)])
class TestMath:
    def test_add(self, test_input, expected):
        assert test_input + 1 == expected

    def test_sub(self, test_input, expected):
        assert test_input - 1 != expected
```

ä¹Ÿå¯ä»¥ç›´æ¥ä¸ºæ¨¡å—å®šä¹‰å‚æ•°åŒ–ï¼Œå®ƒå°±åƒ `module fixture` å¯ä»¥è¢«æ•´ä¸ªæ–‡ä»¶æ‰€ä½¿ç”¨ã€‚**æ³¨æ„æ­¤ç§æ–¹å¼å¿…é¡»ç”¨ `pytestmark` æ¥å‘½åï¼Œç®—æ˜¯ä¸€ç§è¯­æ³•ç³–**

```py
import pytest

pytestmark = pytest.mark.parametrize('test_input, expected', [(2, 3), (4, 5)])

class TestMath:
    def test_add(self, test_input, expected):
        assert test_input + 1 == expected

    def test_sub(self, test_input, expected):
        assert test_input - 1 != expected
```

### å¤šä¸ªå‚æ•°åŒ–æ¨¡å¼

å¯ä»¥ä½¿ç”¨å †å è£…é¥°å™¨çš„æ¨¡å¼è·å–å¤šä¸ªå‚æ•°åŒ–æ¨¡å¼ï¼Œæ‰§è¡Œçš„æ¬¡æ•°ç­‰äºæ‰€æœ‰å‚æ•°çš„æ’åˆ—ç»„åˆæ•°ã€‚é€‚ç”¨åœºæ™¯åº”è¯¥ä¸å¤š

```py
import pytest

@pytest.mark.parametrize('x', [1, 2])
@pytest.mark.parametrize('y', [3, 4])
def test_params(x, y):
    # æ‰§è¡Œæ¬¡æ•°ä¸º 4 æ­¤
    # 1, 3
    # 2, 3
    # 1, 3
    # 2, 4
    print(x, y)
    pass
```

## è·³è¿‡æµ‹è¯•ä¸æ ‡è®°å¤±è´¥

### æµ‹è¯•ç”¨ä¾‹çš„è·³è¿‡ä¸æ ‡è®°å¤±è´¥

éšç€ç³»ç»Ÿçš„è¿­ä»£ï¼Œä¸å…æœ‰ä¸€äº›ç”¨ä¾‹ä¼šé™·å…¥çŸ­æš‚çš„ä¸å¯ç”¨çŠ¶æ€ã€‚æˆ–è€…è¯´å®ƒç›®å‰å¯èƒ½å°±æ˜¯éœ€è¦ä¸€ä¸ªå¤±è´¥çš„çŠ¶æ€ã€‚æ­¤æ—¶å¯ä»¥ä½¿ç”¨ `pytest.mark` æ¥è·³è¿‡æˆ–è€…æ ‡è®°å¤±è´¥è¿™äº›ç”¨ä¾‹ã€‚

```py
import pytest

@pytest.mark.xfail
def test_case_01():
    assert 1 == 2

@pytest.mark.skip(reason='è€ç‰ˆæœ¬çš„æµ‹è¯•ç”¨ä¾‹ï¼Œæš‚æ—¶è·³è¿‡')
def test_case_02():
    assert 1 == 1

@pytest.mark.skipif(condition=True , reason='æ»¡è¶³æ¡ä»¶å°±è·³è¿‡è¿™ä¸ªç”¨ä¾‹')
def test_case_03():
    assert 1 in [1]
```

å½“ç„¶ `xfail` ä¹Ÿæœ‰ä¸€äº›å‚æ•°å¯ä»¥æŒ‡å®šã€‚

- `condition` æ»¡è¶³æ¡ä»¶å°±æ ‡è®°å¤±è´¥ï¼Œæ¯”å¦‚åˆ¤æ–­æ˜¯å¦æ˜¯ windows ç³»ç»Ÿ `sys.platform == 'win32'`
- `reason` æ ‡è®°å¤±è´¥çš„åŸå› 
- `raises` æŒ‡å®šå¼‚å¸¸ç±»å‹
- `run` æŒ‡å®šæ˜¯å¦è¿è¡Œè¯¥ç”¨ä¾‹

`æ­¤å¤– `xfail` è¿˜å­˜åœ¨ä¸€ç§ä¸¥æ ¼æ¨¡å¼ `xfail_strict=true`, å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œé…ç½®`

```py
import sys
import pytest

@pytest.mark.xfail(condition=sys.platform == 'win32', reason='æ»¡è¶³æ¡ä»¶å°±æ ‡è®°å¤±è´¥', raises=Exception, run=True)
def test_case_04():
    assert 1 == 2
```

#### å‚æ•°åŒ–çš„ç”¨ä¾‹æ ‡è®°å¤±è´¥ã€è·³è¿‡

ä½¿ç”¨ `pytest.param` åˆ¶å®šå‚æ•°åŒ–ç”¨ä¾‹çš„è·³è¿‡æˆ–è€…å¤±è´¥

```py
import pytest

@pytest.mark.parametrize('test_input, expected', [(2, 3), pytest.param(4, 4, marks=pytest.mark.xfail)])
def test_params_data(test_input, expected):
    assert test_input + 1 == expected
```


### å‚æ•°åŒ–çš„ fixture æ ‡è®°å¤±è´¥ã€è·³è¿‡

ä½¿ç”¨ `pytest.param` æŒ‡å®š `fixture` çš„å‚æ•°åŒ–ï¼Œé€šè¿‡ `marks` æŒ‡å®šæ ‡è®°æ˜¯å¤±è´¥è¿˜æ˜¯è·³è¿‡ã€‚

```py
import pytest

@pytest.fixture(params=[1, 2, pytest.param(3, marks=pytest.mark.skip)])
def params_data(request):
    return request.param
```

## æ–­è¨€å’Œå¼‚å¸¸

`pytest` ä¸­çš„æ–­è¨€æ›´åŠ çš„ç®€çº¦ï¼Œä½¿ç”¨äº†åŸç”Ÿçš„ `assert` è¯­å¥æ¥åˆ¤å®šç»“æœæ˜¯å¦ç¬¦åˆé¢„æœŸã€‚

```py
assert 1 == 1
```

æœ‰äº›æ—¶å€™ï¼Œå¯èƒ½ä¸ºäº†æ•è·ä¸€äº›ç¨‹åºçš„å¼‚å¸¸ï¼Œä½ ä¹Ÿå¯ä»¥æ–­è¨€ä¸€äº›å¼‚å¸¸ã€‚æ¯”å¦‚æœ‰ä¸ªæ¥å£è¯·æ±‚è¶…æ—¶äº†ã€‚

```py
import pytest

# æ¨¡æ‹Ÿæ¥å£è¯·æ±‚ï¼Œè·å–æ•°æ®è¶…æ—¶
def api_data():
    raise TimeoutError()

def test_api_timeout():
    with pytest.raises(TimeoutError) as error:
        api_data()

    assert error.type == TimeoutError
```

## è­¦å‘Šä¿¡æ¯çš„è¿‡æ»¤

åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œå¦‚æœå‡ºç°äº†ä¸€äº›è­¦å‘Šä¿¡æ¯ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡ `filterwarnings` æ¥è¿‡æ»¤æ‰ã€‚

```py
import pytest
import warnings

def api_v1():
    warnings.warn(UserWarning('api v1, è¿™æ˜¯è€çš„ api å°½å¿«æ›´æ–°åˆ° api v2'))
    return 1

@pytest.mark.filterwarnings('ignore:api v1')
def test_case_01():
    assert api_v1() == 2
```